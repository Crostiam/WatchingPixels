<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ProjLib - Mini OS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="description" content="A Mini OS in your browser">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <style>
    :root {
      --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#8b5cf6;--primary-rgb:99,102,241;
      --accent:#f59e0b;--accent-dark:#d97706;
      --bg-dark:#0f0f23;--bg-darker:#070716;--bg-surface:#1a1a2e;
      --bg-glass:rgba(30,30,50,.8);--bg-overlay:rgba(15,15,35,.9);
      --glass-bg:rgba(255,255,255,.08);
      --text-light:#e2e8f0;--text-lighter:#f8fafc;--text-primary:#cbd5e1;--text-secondary:#94a3b8;--text-dark:#1e293b;
      --success:#22c55e;--error:#ef4444;--warning:#f59e0b;--info:#06b6d4;
      --glass-border:rgba(255,255,255,.1);
      --border-radius:12px;--border-radius-sm:8px;
      --taskbar-height:48px;--topbar-height:48px;
      --font-family-primary:"Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
      --font-family-mono:"JetBrains Mono","SF Mono",Monaco,monospace;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(135deg,var(--bg-dark) 0%,var(--bg-darker) 100%);color:var(--text-primary);font-family:var(--font-family-primary);min-height:100vh;overflow:hidden}
    body::before{content:'';position:fixed;inset:0;z-index:-1;background:radial-gradient(circle at 20% 50%,rgba(var(--primary-rgb),.12) 0%,transparent 55%),radial-gradient(circle at 80% 20%,rgba(139,92,246,.12) 0%,transparent 55%);animation:floatBg 22s ease-in-out infinite}
    @keyframes floatBg{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}

    /* Desktop */
    #desktop{position:fixed;top:var(--topbar-height);left:0;right:0;bottom:var(--taskbar-height);background-size:cover;background-position:center;padding:20px;user-select:none}
    #desktop-icons{position:relative;width:100%;height:100%}
    .desktop-icon{position:absolute;display:flex;flex-direction:column;align-items:center;gap:8px;width:100px;padding:10px;border-radius:var(--border-radius-sm);cursor:pointer;text-align:center;font-size:13px;color:var(--text-lighter);text-shadow:1px 1px 3px rgba(0,0,0,.5);border:1px solid transparent;transition:top .2s,left .2s,background .18s,border-color .18s}
    .desktop-icon:hover,.desktop-icon.selected{background:rgba(var(--primary-rgb),.22);border-color:rgba(var(--primary-rgb),.45)}
    .desktop-icon i{font-size:36px;color:#fff;pointer-events:none}
    .desktop-icon-name{width:100%;word-wrap:break-word;pointer-events:none;padding:2px}
    .desktop-icon-name.editing{pointer-events:all;background:#fff;color:#000;outline:1px solid var(--primary)}
    #selection-box{position:absolute;border:1px solid var(--primary);background:rgba(var(--primary-rgb),.25);z-index:1000;pointer-events:none}

    /* Top bar */
    #top-controls{position:fixed;top:0;left:0;right:0;height:var(--topbar-height);background:var(--bg-glass);backdrop-filter:blur(10px);border-bottom:1px solid var(--glass-border);display:flex;align-items:center;gap:6px;padding:0 10px;z-index:1000}
    #system-info{margin-left:auto;display:flex;align-items:center;gap:14px}
    #clock{padding:6px 12px;background:var(--glass-bg);border:1px solid var(--glass-border);border-radius:var(--border-radius-sm);font-family:var(--font-family-mono);font-size:13px}
    #url-container{display:flex;gap:6px;flex:1;max-width:520px;margin:0 6px}
    #url-input{flex:1;padding:8px 12px;border-radius:12px;border:1px solid var(--glass-border);background:var(--glass-bg);color:var(--text-primary);font-size:13px}
    #go-btn,.control-btn{background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--text-primary);border-radius:var(--border-radius-sm);padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:12.5px;font-weight:500}
    #go-btn{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-dark) 100%);color:#fff}
    #manual-save-btn[disabled]{opacity:.55;cursor:not-allowed}
    #manual-save-btn{position:relative}
    #manual-save-btn .cooldown-badge{position:absolute;top:-6px;right:-6px;background:#ffbd2e;color:#000;font-size:10px;padding:2px 6px;border-radius:12px;font-weight:600;box-shadow:0 0 0 1px rgba(0,0,0,.25)}

    /* Taskbar */
    #taskbar{position:fixed;bottom:0;left:0;right:0;height:var(--taskbar-height);background:var(--bg-glass);backdrop-filter:blur(10px);border-top:1px solid var(--glass-border);display:flex;align-items:center;gap:10px;padding:0 14px;z-index:1000}
    #start-btn{background:linear-gradient(135deg,var(--accent) 0%,var(--accent-dark) 100%);color:#fff;border:none;border-radius:var(--border-radius-sm);padding:0 16px;height:36px;cursor:pointer;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600}
    #taskbar-apps{display:flex;gap:6px;flex:1;overflow-x:auto}
    .taskbar-item{background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--text-primary);border-radius:var(--border-radius-sm);padding:6px 10px;height:32px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:12.5px;font-weight:500;white-space:nowrap}
    .taskbar-item.active{background:rgba(var(--primary-rgb),.25);border-color:var(--primary)}

    /* Windows */
    .window{position:absolute;min-width:340px;min-height:240px;background:var(--bg-glass);backdrop-filter:blur(10px);border:1px solid var(--glass-border);border-radius:var(--border-radius);box-shadow:0 25px 50px -12px rgba(0,0,0,.4),0 0 0 1px rgba(99,102,241,.1);display:flex;flex-direction:column;overflow:hidden;z-index:100;resize:both;animation:fadeIn .25s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
    .window.maximized{top:-20px!important;left:-20px!important;width:calc(100% + 40px)!important;height:calc(100% + 40px)!important;resize:none;border-radius:0}
    .window.minimized{display:none}
    .window.active{z-index:101;box-shadow:0 0 0 2px var(--primary),0 25px 50px -12px rgba(0,0,0,.4)}
    .window-header{background:linear-gradient(135deg,var(--bg-surface) 0%,rgba(var(--primary-rgb),.12) 100%);border-bottom:1px solid var(--glass-border);padding:8px 12px;display:flex;justify-content:space-between;align-items:center;cursor:grab}
    .window-header.dragging{cursor:grabbing}
    .window-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;display:flex;align-items:center;gap:8px;font-size:13px}
    .window-controls{display:flex;gap:6px}
    .window-control{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;color:#fff;flex-shrink:0;opacity:.95;transition:.18s}
    .window-control:hover{transform:scale(1.08);opacity:1}
    .window-close{background:#ff5f56}.window-minimize{background:#ffbd2e}.window-maximize{background:#27c93f}.window-refresh{background:var(--info)}.window-fullscreen{background:var(--primary)}
    .window-content{flex:1;background:rgba(255,255,255,.97);display:flex;flex-direction:column;color:var(--text-dark);position:relative}

    .window-title.unsaved span::after{content:" *";color:var(--accent);font-weight:400}

    /* Editors */
    .editor-wrapper{display:flex;height:100%}
    .editor-lines{width:46px;background:#f3f3f3;color:#888;font-family:var(--font-family-mono);font-size:11px;padding:6px 4px;overflow:hidden;text-align:right;user-select:none;border-right:1px solid #ddd}
    .editor-textarea{flex:1;font-family:var(--font-family-mono);font-size:13px;padding:8px 10px;border:none;outline:none;resize:none;background:#fff;color:#222;line-height:1.4}
    .html-editor-split{display:flex;flex:1;overflow:hidden}
    .html-preview-pane{flex:1;background:#1e1e1e;color:#ddd;overflow:auto;font-family:var(--font-family-mono);padding:10px}
    .html-preview-pane pre{margin:0}

    /* Calculator */
    .calculator-window .window-content{padding:10px;background:#f5f5f5}
    .calc-display{background:#222;color:#0fffa8;font-size:2.05em;padding:14px 12px;text-align:right;border-radius:8px;margin-bottom:10px;font-family:var(--font-family-mono);overflow:hidden;letter-spacing:1px}
    .calc-buttons{display:grid;grid-template-columns:repeat(4,1fr);gap:6px}
    .calc-buttons button{padding:16px;font-size:1.05em;border:none;border-radius:8px;cursor:pointer;background:#fff;box-shadow:inset 0 0 0 1px #ddd;transition:.15s;font-weight:500}
    .calc-buttons button.operator{background:#6366f1;color:#fff}
    .calc-buttons button.equal{background:#22c55e;color:#fff;grid-column:span 2}
    .calc-buttons button:hover{filter:brightness(.95)}
    .calc-buttons button:active{transform:scale(.96)}

    /* Bookmarks */
    #bookmarks-overlay{position:fixed;inset:0;background:var(--bg-overlay);backdrop-filter:blur(10px);z-index:2000;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px}
    #bookmarks-container{display:flex;flex-wrap:wrap;gap:24px;justify-content:center;width:90%;max-width:1200px;max-height:80vh;padding:32px;background:var(--bg-glass);border-radius:var(--border-radius);overflow-y:auto}
    .select-container{display:flex;align-items:center;gap:10px;background:var(--glass-bg);padding:10px;border-radius:var(--border-radius-sm);border:1px solid var(--glass-border)}
    .select-container i{font-size:22px;color:var(--primary-light)}
    .select-container select{background:transparent;border:none;color:var(--text-light);font-size:14px;appearance:none;cursor:pointer}
    #custom-bookmarks{flex-shrink:0;width:100%;background:rgba(var(--primary-rgb),.07);border:1px solid var(--glass-border);border-radius:var(--border-radius);padding:24px}
    .bookmark-list{max-height:300px;overflow-y:auto;margin-right:-10px;padding-right:10px}
    .bookmark-item{padding:10px 12px;margin-bottom:8px;background:var(--glass-bg);border-radius:var(--border-radius-sm);cursor:pointer;display:flex;align-items:center;justify-content:space-between;position:relative;font-size:13px}
    .bookmark-item .delete-bookmark{background:var(--error);color:#fff;border:none;border-radius:50%;width:18px;height:18px;font-size:11px;line-height:18px;text-align:center;cursor:pointer;opacity:0;transition:opacity .2s}
    .bookmark-item:hover .delete-bookmark{opacity:1}
    #add-bookmark-form{display:flex;gap:10px;margin-top:15px}
    #add-bookmark-form input{flex:1;padding:8px;font-size:12.5px}

    /* Context menu & notification */
    #context-menu{position:fixed;background:var(--bg-glass);backdrop-filter:blur(10px);border:1px solid var(--glass-border);border-radius:var(--border-radius);box-shadow:0 25px 50px -12px rgba(0,0,0,.25);z-index:3000;display:none;padding:6px;min-width:210px}
    .context-item{padding:9px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-radius:8px;font-size:12.5px;font-weight:500}
    .context-item:hover{background:rgba(var(--primary-rgb),.18)}
    #notification{position:fixed;top:70px;right:24px;padding:12px 16px;background:var(--bg-glass);backdrop-filter:blur(10px);border-left:4px solid var(--primary);border-radius:var(--border-radius);box-shadow:0 25px 50px -12px rgba(0,0,0,.25);z-index:2001;transform:translateX(calc(100% + 24px));transition:transform .4s cubic-bezier(.175,.885,.32,1.275);font-size:13px;font-weight:500}
    #notification.show{transform:translateX(0)}

    /* Settings */
    .settings-window .window-content{padding:20px;overflow-y:auto;background:#f0f2f5}
    .settings-section{margin-bottom:24px;padding-bottom:20px;border-bottom:1px solid #d5d7db}
    .settings-section:last-child{border-bottom:none}
    .settings-section h3{margin:0 0 12px;font-size:15px}
    .settings-section small{display:block;color:#555;margin-top:6px;font-size:11px}

    /* Alarm */
    #alarm-modal{position:fixed;inset:0;background:var(--bg-overlay);z-index:9999;display:none;align-items:center;justify-content:center}
    #alarm-modal-content{background:var(--bg-surface);color:var(--text-light);padding:40px;border-radius:var(--border-radius);text-align:center;max-width:320px}
    #alarm-modal-content i{font-size:48px;color:var(--warning)}
    #alarm-modal-content h2{margin:20px 0 18px}
    #alarm-stop-btn{background:var(--error);color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600}

    /* Terminal */
    .terminal-content{background:#000;color:#0f0;font-family:var(--font-family-mono);padding:10px;height:100%;overflow-y:auto;white-space:pre-wrap;font-size:12px}
    .terminal-input-line{display:flex}
    .terminal-prompt{white-space:pre}
    .terminal-input{flex:1;background:none;border:none;color:#0f0;font-family:var(--font-family-mono);outline:none;font-size:12px}
  </style>
</head>
<body>
  <div id="loading-overlay" style="position:fixed;inset:0;background:var(--bg-dark);display:flex;align-items:center;justify-content:center;z-index:10000;transition:opacity .5s ease-out;">Loading...</div>

  <!-- Auth -->
  <div id="auth-modal">
    <div id="auth-card">
      <h2>Sign In</h2>
      <p style="font-size:12px;line-height:1.45;color:var(--text-light);background:rgba(255,255,255,.06);padding:8px 10px;border-radius:8px;margin-top:-2px;">
        Data persistence: Email / Google accounts sync your desktop, files, bookmarks & settings to the cloud. <strong>Anonymous / Guest</strong> sessions are stored only in this browser (local only, not synced).
      </p>
      <div id="auth-loading-bar"></div>
      <input type="email" id="auth-email" placeholder="Email">
      <input type="password" id="auth-password" placeholder="Password">
      <div style="display:flex;gap:10px;">
        <button id="login-btn" class="auth-btn" style="flex:1;">Login</button>
        <button id="register-btn" class="auth-btn alt" style="flex:1;">Register</button>
      </div>
      <button id="google-btn" class="auth-btn alt"><i class="ri-google-fill"></i> Continue with Google</button>
      <div class="sep">or</div>
      <button id="anon-btn" class="auth-btn alt">Continue Anonymously</button>
      <div id="auth-error"></div>
    </div>
  </div>
  <div id="user-badge">
    <span id="user-label"></span>
    <button id="signout-btn" title="Sign out"><i class="ri-logout-box-r-line"></i></button>
  </div>

  <!-- Desktop -->
  <div id="desktop"><div id="desktop-icons"></div></div>

  <!-- Top controls -->
  <div id="top-controls">
    <button class="control-btn" id="bookmarks-btn" title="Bookmarks"><i class="ri-bookmark-line"></i></button>
    <button class="control-btn" id="home-btn" title="Home"><i class="ri-home-4-line"></i></button>
    <div id="url-container">
      <input id="url-input" type="text" placeholder="Enter URL...">
      <button id="go-btn">GO</button>
    </div>
    <button class="control-btn" id="manual-save-btn" title="Save now (2 min cooldown)"><i class="ri-save-3-line"></i><span>Save</span></button>
    <div id="system-info"><div id="clock"></div></div>
  </div>

  <!-- Taskbar -->
  <div id="taskbar">
    <button id="start-btn"><i class="ri-apps-line"></i><span>Start</span></button>
    <div id="taskbar-apps"></div>
  </div>

  <!-- Bookmarks Overlay -->
  <div id="bookmarks-overlay">
    <button id="close-bookmarks" aria-label="Close bookmarks" style="position:absolute;top:20px;right:20px;background:var(--error);color:#fff;border:none;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:20px;"><i class="ri-close-line"></i></button>
    <h2 style="color:var(--primary);margin-bottom:20px;flex-shrink:0;width:100%;text-align:center;">Bookmarks</h2>
    <div id="bookmarks-container">
      <div class="select-container"><i class="ri-brain-line"></i><select class="bookmark-select"><option value="">Brain Tease</option><option value="https://www.mindgames.com/">Mind Games</option><option value="https://www.brainzilla.com/">Brainzilla</option><option value="https://www.puzzleprime.com/">Puzzle Prime</option></select></div>
      <div class="select-container"><i class="ri-movie-line"></i><select class="bookmark-select"><option value="">Animation</option><option value="https://www.anitube.news/">Anitube</option><option value="https://aniwatchtv.to/">AniWatch</option><option value="https://aniwave.se/">AniWave</option></select></div>
      <div class="select-container"><i class="ri-book-open-line"></i><select class="bookmark-select"><option value="">Readable</option><option value="https://www.mangahere.cc/">MangaHere</option><option value="https://www.manhwaden.com/">Manhwaden</option><option value="https://readcomiconline.li/">ReadComicOnline</option><option value="https://gutenberg.org/">Project Gutenberg</option><option value="https://en.readanybook.com/">READanyBOOK</option><option value="https://readallcomics.com/">ReadAllComics</option><option value="https://www.theblackvault.com/documentarchive/">TheBlackVault</option></select></div>
      <div class="select-container"><i class="ri-video-line"></i><select class="bookmark-select"><option value="">Watchable</option><option value="https://tv.garden">Free Worldwide TV</option><option value="https://flixer.su/">Flixer</option><option value="https://www.couchtuner.show/">CouchTuner</option><option value="https://moviedb.wiki/">Movie DB</option><option value="https://www.hydraflix.vip/">HydraFlix</option><option value="https://watchseries.bar/">WatchSeries</option><option value="https://nflsupport.com/">Sports</option></select></div>
      <div class="select-container"><i class="ri-calendar-line"></i><select class="bookmark-select"><option value="">Dailies</option><option value="https://term.ooo/">Termo</option><option value="https://bandle.app/daily">Bandle</option><option value="https://wordleplay.com/waffle">Waffle</option><option value="https://musicle.app">Musicle</option></select></div>
      <div id="custom-bookmarks">
        <h3><i class="ri-user-star-line"></i> My Bookmarks</h3>
        <div class="bookmark-list" id="custom-bookmarks-list"></div>
        <form id="add-bookmark-form">
          <input type="text" id="new-bookmark-name" placeholder="Name" required>
          <input type="text" id="new-bookmark-url" placeholder="URL" required>
          <button type="submit" id="add-bookmark-btn">+</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Misc -->
  <div id="context-menu"></div>
  <div id="notification"></div>
  <div id="selection-box"></div>

  <!-- Alarm -->
  <div id="alarm-modal">
    <div id="alarm-modal-content">
      <i class="ri-alarm-warning-line"></i>
      <h2>Alarm!</h2>
      <button id="alarm-stop-btn">Stop</button>
    </div>
  </div>

  <audio id="alarm-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto" loop></audio>
  <audio id="music-player-audio"></audio>

  <script type="module">
    /**************** Firebase Setup ****************/
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword,
      createUserWithEmailAndPassword, signOut, GoogleAuthProvider,
      signInWithPopup, signInAnonymously
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyCcWvib3qSdFko7FssDvEeKCe0ZtXtyQSY",
      authDomain:"minios-d4b84.firebaseapp.com",
      projectId:"minios-d4b84",
      storageBucket:"minios-d4b84.appspot.com",
      messagingSenderId:"253773195543",
      appId:"1:253773195543:web:35b3f0c605eb66dcdc2f52"
    };
    const fbApp = initializeApp(firebaseConfig);
    const auth = getAuth(fbApp);
    const db = getFirestore(fbApp);

    /**************** Auth UI ****************/
    const authModal = document.getElementById('auth-modal');
    const loginBtn = document.getElementById('login-btn');
    const registerBtn = document.getElementById('register-btn');
    const anonBtn = document.getElementById('anon-btn');
    const googleBtn = document.getElementById('google-btn');
    const authEmail = document.getElementById('auth-email');
    const authPw = document.getElementById('auth-password');
    const authErr = document.getElementById('auth-error');
    const authBar = document.getElementById('auth-loading-bar');
    const userBadge = document.getElementById('user-badge');
    const userLabel = document.getElementById('user-label');
    const signoutBtn = document.getElementById('signout-btn');
    const providerGoogle = new GoogleAuthProvider();

    function showAuthModal(show=true){ authModal.style.display = show ? 'flex' : 'none'; }
    function setAuthLoading(l){ authBar.style.display = l?'block':'none'; [loginBtn,registerBtn,anonBtn,googleBtn].forEach(b=>b.disabled=l); }
    function setAuthError(msg=''){ authErr.textContent = msg; }

    loginBtn.onclick = async () => { setAuthError(); setAuthLoading(true);
      try { await signInWithEmailAndPassword(auth, authEmail.value.trim(), authPw.value); }
      catch(e){ setAuthError(e.message); } setAuthLoading(false); };
    registerBtn.onclick = async () => { setAuthError(); setAuthLoading(true);
      try { await createUserWithEmailAndPassword(auth, authEmail.value.trim(), authPw.value); }
      catch(e){ setAuthError(e.message); } setAuthLoading(false); };
    anonBtn.onclick = async () => { setAuthError(); setAuthLoading(true);
      try { await signInAnonymously(auth); }
      catch(e){ setAuthError(e.message); } setAuthLoading(false); };
    googleBtn.onclick = async () => { setAuthError(); setAuthLoading(true);
      try { await signInWithPopup(auth, providerGoogle); }
      catch(e){ setAuthError(e.message); } setAuthLoading(false); };
    signoutBtn.onclick = () => signOut(auth);

    /**************** Config & Defaults ****************/
    const config = {
      defaultUrl: "https://archive.org",
      defaultWindowSize: { width: 800, height: 600 },
      backgroundOptions: [
        { name:"Cyberpunk", url:"https://images.unsplash.com/photo-1639762681057-408e52192e55?q=80&w=2232&auto=format&fit=crop" },
        { name:"Nature", url:"https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=2940&auto=format&fit=crop" },
        { name:"Space", url:"https://images.unsplash.com/photo-1454789548928-9efd52dc4031?q=80&w=2980&auto=format&fit=crop" }
      ],
      gridSize: 100
    };
    const defaultDesktopItems = {
      'File Explorer': { type:'app', appId:'explorer', icon:'ri-folder-line' },
      'HTML Editor': { type:'app', appId:'htmlEditor', icon:'ri-code-s-slash-line' },
      'Settings': { type:'app', appId:'settings', icon:'ri-settings-3-line' },
      'Calculator': { type:'app', appId:'calculator', icon:'ri-calculator-line' },
      'Clock': { type:'app', appId:'clock', icon:'ri-time-line' },
      'Terminal': { type:'app', appId:'terminal', icon:'ri-terminal-box-line' },
      'Music Player': { type:'app', appId:'music', icon:'ri-music-2-line' },
      'Help': { type:'app', appId:'help', icon:'ri-question-line' },
      'Bookmarks': { type:'app', appId:'bookmarks', icon:'ri-bookmarks-line' },
      'Welcome.txt': { type:'file', content:'Welcome to your Mini OS!\n\nTo get started, right-click on the desktop...' },
      'Images': { type:'folder', children:{ 'cyber-cat.jpg':{ type:'file', content:'https://i.pinimg.com/originals/44/1a/c9/441ac90467439745d3163689cc5943a9.jpg' } } },
      'Music': { type:'folder', children:{ 'lofi-beat.mp3':{ type:'file', content:'https://cdn.pixabay.com/download/audio/2022/02/07/audio_c6b9b8d96e.mp3' } } }
    };
    let initialFileSystem = JSON.parse(localStorage.getItem("fileSystem"));
    if(!initialFileSystem){
      initialFileSystem = { 'Desktop': { type:'folder', children: JSON.parse(JSON.stringify(defaultDesktopItems)) } };
    }

    /**************** State ****************/
    let state = {
      windows: [],
      activeWindow: null,
      zIndex: 100,
      nextWindowId: 1,
      background: localStorage.getItem("background") || config.backgroundOptions[0].url,
      bookmarks: JSON.parse(localStorage.getItem("bookmarks")) || [],
      alarms: JSON.parse(localStorage.getItem("alarms")) || [],
      fileSystem: initialFileSystem,
      iconPositions: JSON.parse(localStorage.getItem("iconPositions")) || {},
      selectedIcons: new Set(),
      isRenaming: false
    };

    /**************** Persist Open Browser Windows ****************/
    const BROWSER_SAVE_KEY="openBrowserWindows";
    let restoringBrowsers=false;
    function snapshotOpenBrowserWindows(){
      if(restoringBrowsers) return;
      const urls = state.windows
        .filter(w=>w.appId==='browser')
        .map(w=>w.element.querySelector('iframe')?.src)
        .filter(Boolean);
      localStorage.setItem(BROWSER_SAVE_KEY, JSON.stringify(urls));
    }
    function restoreBrowserWindows(){
      const list=JSON.parse(localStorage.getItem(BROWSER_SAVE_KEY)||"[]");
      if(!Array.isArray(list) || !list.length) return;
      restoringBrowsers=true;
      list.forEach(url=>appManager.launch('browser',url));
      setTimeout(()=>{restoringBrowsers=false;},100);
    }
    window.addEventListener('beforeunload', snapshotOpenBrowserWindows);

    /**************** Cloud Sync (Guest Disabled) ****************/
    const clientId = (crypto?.randomUUID && crypto.randomUUID()) || Math.random().toString(36).slice(2);
    let cloudUser = null;
    let pendingSaveTimer = null;
    let lastAppliedRemoteMs = 0;
    let unsubscribeUserDoc = null;
    const SAVE_DEBOUNCE_MS = 1000;
    const isCloudEnabled = ()=>!!(cloudUser && !cloudUser.isAnonymous);

    async function loadCloudState(uid){
      if(!isCloudEnabled()) return;
      try{
        const ref = doc(db, "users", uid);
        const snap = await getDoc(ref);
        if(snap.exists()){
          const data=snap.data();
          applyRemoteData(data,true);
          if(data.clientUpdatedAt) lastAppliedRemoteMs = data.clientUpdatedAt;
        } else {
          await pushCloudState();
        }
        applyStateToUI();
        startRealtimeListener(uid);
      }catch(e){ console.error("Cloud load error:", e); }
    }
    function startRealtimeListener(uid){
      if(!isCloudEnabled()||unsubscribeUserDoc) return;
      unsubscribeUserDoc = onSnapshot(doc(db,"users",uid), snap=>{
        if(!snap.exists()) return;
        const data=snap.data();
        if(data.clientId===clientId) return;
        if(data.clientUpdatedAt && data.clientUpdatedAt>lastAppliedRemoteMs){
          applyRemoteData(data,false);
          lastAppliedRemoteMs=data.clientUpdatedAt;
          applyStateToUI();
        }
      }, err=>console.error("Realtime listener error:",err));
    }
    function applyRemoteData(data, initial){
      state.background    = data.background    ?? state.background;
      state.bookmarks     = data.bookmarks     ?? state.bookmarks;
      state.alarms        = data.alarms        ?? state.alarms;
      state.iconPositions = data.iconPositions ?? state.iconPositions;
      state.fileSystem    = data.fileSystem    ?? state.fileSystem;
      if(initial){
        localStorage.setItem("background", state.background);
        localStorage.setItem("bookmarks", JSON.stringify(state.bookmarks));
        localStorage.setItem("alarms", JSON.stringify(state.alarms));
        localStorage.setItem("iconPositions", JSON.stringify(state.iconPositions));
        localStorage.setItem("fileSystem", JSON.stringify(state.fileSystem));
      }
    }
    function scheduleCloudSave(){
      if(!isCloudEnabled()) return;
      if(pendingSaveTimer) clearTimeout(pendingSaveTimer);
      pendingSaveTimer=setTimeout(()=>pushCloudState(), SAVE_DEBOUNCE_MS);
    }
    async function pushCloudState(){
      if(!isCloudEnabled()) return;
      try{
        const payload={
          background:state.background,bookmarks:state.bookmarks,alarms:state.alarms,
          iconPositions:state.iconPositions,fileSystem:state.fileSystem,
          updatedAt:serverTimestamp(),clientUpdatedAt:Date.now(),clientId
        };
        lastAppliedRemoteMs=payload.clientUpdatedAt;
        await setDoc(doc(db,"users",cloudUser.uid), payload, { merge:true });
      }catch(e){ console.error("Cloud save error:", e); }
    }

    /**************** Export / Import ****************/
    function exportProfile(){
      const profile = {
        version:1,exportedAt:new Date().toISOString(),
        background:state.background,bookmarks:state.bookmarks,alarms:state.alarms,
        iconPositions:state.iconPositions,fileSystem:state.fileSystem
      };
      const blob = new Blob([JSON.stringify(profile,null,2)], {type:'application/json'});
      const a=document.createElement('a');
      a.href=URL.createObjectURL(blob);
      a.download='miniOS-profile.json';
      document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove();},0);
      utils.showNotification("Profile exported.","success");
    }
    function importProfileData(json){
      try{
        const data=JSON.parse(json);
        ['background','bookmarks','alarms','iconPositions','fileSystem'].forEach(k=>{ if(!(k in data)) throw new Error("Missing key "+k); });
        state.background=data.background;
        state.bookmarks=data.bookmarks;
        state.alarms=data.alarms;
        state.iconPositions=data.iconPositions;
        state.fileSystem=data.fileSystem;
        utils.saveState({immediate:true});
        applyStateToUI();
        utils.showNotification("Profile imported.","success");
      }catch(err){ utils.showNotification("Import failed: "+err.message,"error"); }
    }

    /**************** Elements & Utils ****************/
    const elements = {
      desktop: document.getElementById("desktop"),
      desktopIcons: document.getElementById("desktop-icons"),
      selectionBox: document.getElementById("selection-box"),
      urlInput: document.getElementById("url-input"),
      goBtn: document.getElementById("go-btn"),
      bookmarksBtn: document.getElementById("bookmarks-btn"),
      closeBookmarks: document.getElementById("close-bookmarks"),
      homeBtn: document.getElementById("home-btn"),
      taskbarApps: document.getElementById("taskbar-apps"),
      clock: document.getElementById("clock"),
      startBtn: document.getElementById("start-btn"),
      contextMenu: document.getElementById("context-menu"),
      notification: document.getElementById("notification"),
      bookmarksOverlay: document.getElementById("bookmarks-overlay"),
      customBookmarksList: document.getElementById("custom-bookmarks-list"),
      addBookmarkForm: document.getElementById("add-bookmark-form"),
      alarmSound: document.getElementById("alarm-sound"),
      alarmModal: document.getElementById("alarm-modal"),
      alarmStopBtn: document.getElementById("alarm-stop-btn"),
      musicPlayerAudio: document.getElementById("music-player-audio"),
      manualSaveBtn: document.getElementById("manual-save-btn")
    };

    const utils = {
      showNotification:(msg,type="info")=>{
        elements.notification.textContent=msg;
        elements.notification.className=`show ${type}`;
        setTimeout(()=>elements.notification.classList.remove("show"),4000);
      },
      updateClock:()=>{ if(elements.clock) elements.clock.textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}); },
      saveState:({immediate=false}={})=>{
        localStorage.setItem("fileSystem", JSON.stringify(state.fileSystem));
        localStorage.setItem("iconPositions", JSON.stringify(state.iconPositions));
        localStorage.setItem("background", state.background);
        localStorage.setItem("bookmarks", JSON.stringify(state.bookmarks));
        localStorage.setItem("alarms", JSON.stringify(state.alarms));
        snapshotOpenBrowserWindows();
        if(immediate) pushCloudState(); else scheduleCloudSave();
      },
      getIconForFile:(name,item)=>{
        if(item.type==='link') return 'ri-chrome-fill';
        const ext=name.split('.').pop().toLowerCase();
        if(ext===name) return 'ri-file-text-line';
        switch(ext){
          case 'txt':return 'ri-file-text-line';
          case 'jpg':case 'jpeg':case 'png':case 'gif':return 'ri-image-line';
          case 'mp3':case 'wav':case 'ogg':return 'ri-file-music-line';
          case 'zip':case 'rar':return 'ri-file-zip-line';
          case 'js':case 'html':case 'css':return 'ri-file-code-line';
          default:return 'ri-file-line';
        }
      },
      findItemByPath:(path)=>{
        const parts=path.split('/').filter(Boolean);
        if(!parts.length) return state.fileSystem;
        if(parts[0]!=='Desktop') return null;
        let cur=state.fileSystem.Desktop;
        for(let i=1;i<parts.length;i++){
          if(cur.type!=='folder'||!cur.children||!cur.children[parts[i]]) return null;
          cur=cur.children[parts[i]];
        }
        return cur;
      },
      getParentFromPath:(path)=>{
        const parts=path.split('/').filter(Boolean);
        if(parts.length<=1) return null;
        return utils.findItemByPath(parts.slice(0,-1).join('/'));
      },
      getUniqueName:(parent,base)=>{
        let name=base,c=1;
        while(parent.children[name]){
          const ext=base.includes('.')?'.'+base.split('.').pop():'';
          const baseName=base.includes('.')?base.slice(0,base.lastIndexOf('.')):base;
          name=`${baseName} (${c})${ext}`; c++;
        }
        return name;
      },
      createFile:(parentPath,fileName,content='')=>{
        const parent=utils.findItemByPath(parentPath);
        if(parent&&parent.type==='folder'){
          const u=utils.getUniqueName(parent,fileName);
          parent.children[u]={type:'file',content};
          utils.saveState({});
          return `${parentPath}/${u}`;
        }return null;
      },
      createFolder:(parentPath,folderName)=>{
        const parent=utils.findItemByPath(parentPath);
        if(parent&&parent.type==='folder'){
          const u=utils.getUniqueName(parent,folderName);
          parent.children[u]={type:'folder',children:{}};
          utils.saveState({});
          return `${parentPath}/${u}`;
        }return null;
      },
      createLink:(parentPath,linkName,url)=>{
        const parent=utils.findItemByPath(parentPath);
        if(parent&&parent.type==='folder'){
          const u=utils.getUniqueName(parent,linkName);
          parent.children[u]={type:'link',url};
          utils.saveState({});
          return `${parentPath}/${u}`;
        }return null;
      },
      deleteItem:(path)=>{
        const item=utils.findItemByPath(path);
        if(item && item.type==='app'){ utils.showNotification("System applications cannot be deleted.","error"); return false; }
        const parent=utils.getParentFromPath(path);
        const name=path.split('/').pop();
        if(parent && parent.children[name]){
          delete parent.children[name];
          delete state.iconPositions[path];
          utils.saveState({});
          desktopManager.reflowDesktop(); // tidy after delete
          return true;
        }return false;
      },
      renameItem:(path,newName)=>{
        const item=utils.findItemByPath(path);
        if(item && item.type==='app'){ utils.showNotification("System applications cannot be renamed.","error"); return false; }
        const parent=utils.getParentFromPath(path);
        const old=path.split('/').pop();
        if(!parent||!newName||newName===old) return false;
        if(parent.children[newName]){ utils.showNotification("A file with that name exists.","error"); return false; }
        parent.children[newName]=parent.children[old]; delete parent.children[old];
        const newPath=path.substring(0,path.lastIndexOf('/')+1)+newName;
        if(state.iconPositions[path]){
          state.iconPositions[newPath]=state.iconPositions[path];
          delete state.iconPositions[path];
        }
        utils.saveState({});
        desktopManager.reflowDesktop();
        return true;
      }
    };

    /**************** Helper ****************/
    const clamp=(v,min,max)=>v<min?min:(v>max?max:v);

    /**************** Window Manager (bounded drag) ****************/
    const windowManager = {
      create:(opt)=>{
        const id=state.nextWindowId++;
        const pos={x:120+(state.windows.length%8)*30,y:90+(state.windows.length%8)*26};
        const el=document.createElement('div');
        el.className=`window ${opt.className||''}`;
        el.id=`window-${id}`;
        el.style.cssText=`width:${opt.width||400}px;height:${opt.height||300}px;left:${pos.x}px;top:${pos.y}px;`;
        el.innerHTML=`
          <div class="window-header">
            <div class="window-title"><i class="${opt.icon||'ri-window-line'}"></i><span>${opt.title}</span></div>
            <div class="window-controls">
              ${opt.refreshable?'<div class="window-control window-refresh" title="Refresh"><i class="ri-refresh-line"></i></div>':''}
              ${opt.fullscreenable?'<div class="window-control window-fullscreen" title="Fullscreen"><i class="ri-fullscreen-line"></i></div>':''}
              <div class="window-control window-minimize" title="Minimize"><i class="ri-subtract-line"></i></div>
              <div class="window-control window-maximize" title="Maximize"><i class="ri-checkbox-blank-line"></i></div>
              <div class="window-control window-close" title="Close"><i class="ri-close-line"></i></div>
            </div>
          </div>
          <div class="window-content">${opt.content||''}</div>`;
        elements.desktop.appendChild(el);
        const winObj={id,element:el,...opt};
        state.windows.push(winObj);
        windowManager.bind(winObj);
        windowManager.activate(id);
        return winObj;
      },
      bind:(win)=>{
        const header=win.element.querySelector('.window-header');
        header.addEventListener('mousedown',e=>{
          if(e.target.closest('.window-control')) return;
          windowManager.activate(win.id);
          windowManager.startDrag(win,e);
        });
        win.element.querySelector('.window-close').onclick=()=>windowManager.close(win.id);
        win.element.querySelector('.window-minimize').onclick=()=>windowManager.minimize(win.id);
        win.element.querySelector('.window-maximize').onclick=()=>windowManager.maximize(win.id);
        if(win.refreshable) win.element.querySelector('.window-refresh').onclick=()=>{
          const iframe=win.element.querySelector('iframe'); if(iframe) iframe.src=iframe.src;
        };
        if(win.fullscreenable) win.element.querySelector('.window-fullscreen').onclick=()=>windowManager.toggleFullscreen(win.element);

        // snapshot on resize to keep browser list fresh
        const ro=new ResizeObserver(()=>snapshotOpenBrowserWindows());
        ro.observe(win.element);
      },
      startDrag:(win,e)=>{
        e.preventDefault();
        const header=win.element.querySelector('.window-header');
        header.classList.add('dragging');

        const deskRect = elements.desktop.getBoundingClientRect();
        const rect = win.element.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;

        const minVisibleHeader = 60; // keep at least header portion visible

        function move(ev){
          let newLeft = ev.clientX - offsetX - deskRect.left;
          let newTop  = ev.clientY - offsetY - deskRect.top;

          const maxLeft = deskRect.width - minVisibleHeader;
          const maxTop  = deskRect.height - 40;

          newLeft = clamp(newLeft, -(win.element.offsetWidth - minVisibleHeader), maxLeft);
          newTop  = clamp(newTop, 0, Math.max(0,maxTop));

          win.element.style.left = newLeft + 'px';
          win.element.style.top  = newTop  + 'px';
        }
        function up(){
          document.removeEventListener('mousemove',move);
          document.removeEventListener('mouseup',up);
          header.classList.remove('dragging');
          snapshotOpenBrowserWindows();
        }
        document.addEventListener('mousemove',move);
        document.addEventListener('mouseup',up);
      },
      activate:(id)=>{
        const w=state.windows.find(x=>x.id===id); if(!w) return;
        if(state.activeWindow===id && !w.isMinimized) return;
        state.windows.forEach(x=>x.element.classList.remove('active'));
        w.element.classList.add('active');
        w.element.style.zIndex=++state.zIndex;
        state.activeWindow=id;
        if(w.isMinimized) windowManager.restore(id);
        core.updateTaskbar();
      },
      close:(id)=>{
        const w=state.windows.find(x=>x.id===id);
        if(w && w.onClose) w.onClose();
        const idx=state.windows.findIndex(x=>x.id===id);
        if(idx>-1){
          state.windows[idx].element.remove();
          state.windows.splice(idx,1);
          if(state.activeWindow===id){
            state.activeWindow = state.windows.length?state.windows[state.windows.length-1].id:null;
          }
          core.updateTaskbar();
          snapshotOpenBrowserWindows();
        }
      },
      minimize:(id)=>{
        const w=state.windows.find(x=>x.id===id);
        if(w){
          w.element.classList.add('minimized');
          w.isMinimized=true;
          if(state.activeWindow===id) state.activeWindow=null;
          core.updateTaskbar();
          snapshotOpenBrowserWindows();
        }
      },
      restore:(id)=>{
        const w=state.windows.find(x=>x.id===id);
        if(w && w.isMinimized){
          w.element.classList.remove('minimized');
          w.isMinimized=false;
          windowManager.activate(id);
          snapshotOpenBrowserWindows();
        }
      },
      maximize:(id)=>{
        const w=state.windows.find(x=>x.id===id);
        if(w){
          w.element.classList.toggle('maximized');
          snapshotOpenBrowserWindows();
        }
      },
      toggleFullscreen:(el)=>{
        if(!document.fullscreenElement) el.requestFullscreen().catch(err=>utils.showNotification("Error: "+err.message,"error"));
        else document.exitFullscreen();
      }
    };

    /**************** Editor Enhancer ****************/
    function enhancePlainEditor(textarea){
      const wrap=document.createElement('div'); wrap.className='editor-wrapper';
      const lines=document.createElement('div'); lines.className='editor-lines'; lines.textContent='1';
      textarea.classList.add('editor-textarea');
      const parent=textarea.parentElement;
      parent.replaceChild(wrap,textarea);
      wrap.appendChild(lines); wrap.appendChild(textarea);
      function update(){
        const count=textarea.value.split('\n').length;
        let out=''; for(let i=1;i<=count;i++) out+=i+"\\n";
        lines.textContent=out;
      }
      textarea.addEventListener('input',update);
      textarea.addEventListener('scroll',()=>{ lines.scrollTop=textarea.scrollTop; });
      textarea.addEventListener('keydown',e=>{
        if(e.key==='Tab'){
          e.preventDefault();
          const s=textarea.selectionStart, t=textarea.selectionEnd;
          textarea.setRangeText("    ", s, t, 'end');
          update();
        }
      });
      update();
    }

    /**************** Apps ****************/
    const appManager = {
      launch:(id,data)=>{ const app=appManager.apps[id]; if(app) app.launch(data); },
      apps:{
        explorer:{
          launch:(path='Desktop')=>{
            const existing=state.windows.find(w=>w.appId==='explorer');
            if(existing){ appManager.apps.explorer.render(existing,path); windowManager.activate(existing.id); }
            else {
              const win=windowManager.create({title:'File Explorer',icon:'ri-folder-line',className:'file-explorer-window',width:600,height:400,appId:'explorer'});
              appManager.apps.explorer.render(win,path);
            }
          },
          render:(win,path)=>{
            const content=win.element.querySelector('.window-content');
            const titleSpan=win.element.querySelector('.window-title span');
            titleSpan.textContent=path.split('/').pop()||'File Explorer';
            const goUp=()=>{ const parent=path.substring(0,path.lastIndexOf('/')); if(parent) appManager.apps.explorer.render(win,parent); };
            const breadcrumbs=path.split('/').map((p,i,a)=>`<span class="breadcrumb-item" data-path="${a.slice(0,i+1).join('/')}">${p}</span>`).join(' / ');
            content.innerHTML=`
              <div style="display:flex;align-items:center;gap:8px;padding:6px 10px;background:#f1f2f6;border-bottom:1px solid #dadde2;font-size:12px;">
                <button id="back-${win.id}" ${path==='Desktop'?'disabled':''} style="padding:4px 10px;font-size:12px;">◀</button>
                <div style="flex:1;overflow:auto;white-space:nowrap;">${breadcrumbs}</div>
                <button id="reflow-btn-${win.id}" style="padding:4px 8px;font-size:11px;">Reflow Desktop</button>
              </div>
              <div class="file-explorer-grid" style="padding:10px;display:flex;flex-wrap:wrap;gap:10px;"></div>`;
            content.querySelector('#back-'+win.id).onclick=goUp;
            content.querySelectorAll('.breadcrumb-item').forEach(b=>b.onclick=()=>appManager.apps.explorer.render(win,b.dataset.path));
            content.querySelector('#reflow-btn-'+win.id).onclick=()=>{ desktopManager.reflowDesktop(true); utils.showNotification("Desktop icons reflowed.","info"); };
            const grid=content.querySelector('.file-explorer-grid');
            grid.addEventListener('contextmenu',e=>{ if(e.target===grid) desktopManager.showContextMenu(e,'explorer-bg',{path,win}); });
            const folder=utils.findItemByPath(path);
            if(folder && folder.type==='folder'){
              Object.entries(folder.children).forEach(([name,item])=>{
                const icon=document.createElement('div');
                icon.className='desktop-icon';
                icon.dataset.path=`${path}/${name}`;
                const cls=item.type==='folder'?'ri-folder-3-line':(item.type==='app'?item.icon:utils.getIconForFile(name,item));
                icon.innerHTML=`<i class="${cls}"></i><div class="desktop-icon-name">${name}</div>`;
                icon.ondblclick=()=>desktopManager.onIconDoubleClick(item,icon.dataset.path);
                icon.addEventListener('contextmenu',e=>desktopManager.showContextMenu(e,'icon',icon));
                grid.appendChild(icon);
              });
            }
          }
        },
        editor:{
          launch:(path)=>{
            const file=utils.findItemByPath(path); if(!file||file.type!=='file') return;
            const win=windowManager.create({title:path.split('/').pop(),icon:'ri-file-text-line',className:'text-editor-window',width:560,height:640,appId:'editor',
              content:`<div style="flex:1;display:flex;flex-direction:column;">
                <div style="background:#f0f0f0;border-bottom:1px solid #ddd;padding:4px 8px;display:flex;gap:10px;align-items:center;">
                  <button class="save-btn" style="padding:4px 10px;font-size:12px;">Save</button>
                  <small class="save-status" style="opacity:.65;">Saved</small>
                </div>
                <textarea class="text-editor-content"></textarea>
              </div>`});
            const ta=win.element.querySelector('.text-editor-content');
            const title=win.element.querySelector('.window-title');
            const status=win.element.querySelector('.save-status');
            ta.value=file.content; enhancePlainEditor(ta);
            let dirty=false, debounce;
            function markDirty(){ if(!dirty){dirty=true;title.classList.add('unsaved');status.textContent="Unsaved changes...";} }
            function markSaved(){ dirty=false;title.classList.remove('unsaved');status.textContent="Saved"; }
            ta.addEventListener('input',()=>{ file.content=ta.value; markDirty(); clearTimeout(debounce); debounce=setTimeout(()=>utils.saveState({}),350); });
            win.element.querySelector('.save-btn').onclick=()=>{ file.content=ta.value; utils.saveState({immediate:true}); markSaved(); utils.showNotification("Saved.","success"); };
          }
        },
        htmlEditor:{
          launch:()=>{
            const win=windowManager.create({title:'HTML Editor',icon:'ri-code-s-slash-line',className:'html-editor-window',width:900,height:560,appId:'htmlEditor',
              content:`<div style="display:flex;flex-direction:column;height:100%;background:#fff;">
                <div style="padding:6px 8px;background:#f0f0f0;border-bottom:1px solid #ddd;display:flex;gap:8px;align-items:center;">
                  <button class="run-html-btn" style="padding:4px 10px;font-size:12px;">Open in Browser</button>
                  <small style="opacity:.65;">Live preview on the right.</small>
                </div>
                <div class="html-editor-split">
                  <div class="html-editor-pane" style="border-right:1px solid #ddd;"><textarea class="html-editor-content" style="flex:1;border:none;outline:none;font-family:var(--font-family-mono);font-size:13px;padding:10px;resize:none;background:#fff;color:#222;"></textarea></div>
                  <div class="html-preview-pane"><pre><code class="language-html" id="html-preview-code"></code></pre></div>
                </div>
              </div>`});
            const runBtn=win.element.querySelector('.run-html-btn');
            const ta=win.element.querySelector('.html-editor-content');
            const preview=win.element.querySelector('#html-preview-code');
            ta.value=`<!DOCTYPE html>
<html>
<head>
  <title>My Page</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    h1 { color: #6366f1; }
  </style>
</head>
<body>
  <h1>Hello, World!</h1>
  <p>Edit on the left. This preview updates live.</p>
</body>
</html>`;
            function upd(){ preview.textContent=ta.value; if(window.hljs) hljs.highlightElement(preview); }
            let t; ta.addEventListener('input',()=>{ clearTimeout(t); t=setTimeout(upd,200); });
            upd(); enhancePlainEditor(ta);
            runBtn.onclick=()=>{ const blob=new Blob([ta.value],{type:'text/html'}); const url=URL.createObjectURL(blob); appManager.launch('browser',url); };
          }
        },
        imageViewer:{
          launch:(path)=>{
            const file=utils.findItemByPath(path); if(!file||file.type!=='file') return;
            windowManager.create({title:path.split('/').pop(),icon:'ri-image-line',className:'image-viewer-window',width:700,height:500,appId:'imageViewer',
              content:`<div style="flex:1;display:flex;align-items:center;justify-content:center;background:#111;">
                <img src="${file.content}" style="max-width:100%;max-height:100%;object-fit:contain;">
              </div>`});
          }
        },
        music:{
          launch:()=>{
            const playlist=[
              {title:"Lofi Beat",src:"https://cdn.pixabay.com/download/audio/2022/02/07/audio_c6b9b8d96e.mp3"},
              {title:"Ambient Piano",src:"https://cdn.pixabay.com/download/audio/2022/08/03/audio_51f6783591.mp3"},
              {title:"Chill Abstract",src:"https://cdn.pixabay.com/download/audio/2022/01/21/audio_31743c5229.mp3"}
            ];
            let idx=0;
            const win=windowManager.create({title:'Music Player',icon:'ri-music-2-line',className:'music-player-window',width:420,height:340,appId:'music',onClose:()=>elements.musicPlayerAudio.pause(),
              content:`<div style="padding:16px;display:flex;flex-direction:column;gap:12px;align-items:center;">
                <div id="song-title" style="font-weight:600;"></div>
                <div style="display:flex;gap:10px;">
                  <button id="prev-btn"><i class="ri-skip-back-fill"></i></button>
                  <button id="play-pause-btn"><i class="ri-play-fill"></i></button>
                  <button id="next-btn"><i class="ri-skip-forward-fill"></i></button>
                </div>
                <div class="volume-row"><i class="ri-volume-up-line"></i><input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1"></div>
                <div style="display:flex;gap:8px;width:100%;">
                  <input type="text" id="custom-track-url" placeholder="Direct audio URL..." style="flex:1;">
                  <button id="load-track-btn">Load</button>
                </div>
                <div style="width:100%;border-top:1px solid #ccc;padding-top:10px;">
                  <p style="font-size:12px;opacity:.7;margin:0 0 6px;">External playlists open in browser.</p>
                  <div style="display:flex;gap:8px;">
                    <input type="text" id="playlist-url" placeholder="Playlist URL..." style="flex:1;">
                    <button id="open-playlist-btn">Open</button>
                  </div>
                </div>
              </div>`});
            const audio=elements.musicPlayerAudio;
            const root=win.element.querySelector('.window-content');
            const song=root.querySelector('#song-title');
            const pp=root.querySelector('#play-pause-btn');
            const prev=root.querySelector('#prev-btn');
            const next=root.querySelector('#next-btn');
            const custom=root.querySelector('#custom-track-url');
            const load=root.querySelector('#load-track-btn');
            const plist=root.querySelector('#playlist-url');
            const open=root.querySelector('#open-playlist-btn');
            const vol=root.querySelector('#volume-slider');
            function loadTrack(i){ audio.src=playlist[i].src; song.textContent=playlist[i].title; audio.load(); }
            pp.onclick=async()=>{ if(audio.paused){ try{ await audio.play(); pp.innerHTML='<i class="ri-pause-fill"></i>'; }catch{} } else { audio.pause(); pp.innerHTML='<i class="ri-play-fill"></i>'; } };
            next.onclick=async()=>{ idx=(idx+1)%playlist.length; loadTrack(idx); try{ await audio.play(); pp.innerHTML='<i class="ri-pause-fill"></i>'; }catch{} };
            prev.onclick=async()=>{ idx=(idx-1+playlist.length)%playlist.length; loadTrack(idx); try{ await audio.play(); pp.innerHTML='<i class="ri-pause-fill"></i>'; }catch{} };
            audio.onended=()=>next.click();
            load.onclick=async()=>{ const url=custom.value.trim(); if(url){ audio.src=url; song.textContent="Custom Track"; audio.load(); try{ await audio.play(); pp.innerHTML='<i class="ri-pause-fill"></i>'; }catch{} } };
            open.onclick=()=>{ const url=plist.value.trim(); if(url) appManager.launch('browser',url); };
            vol.oninput=()=>{ audio.volume=parseFloat(vol.value); };
            loadTrack(idx);
          }
        },
        terminal:{
          launch:()=>{
            let dir='Desktop',hist=[],hIdx=-1;
            const win=windowManager.create({title:'Terminal',icon:'ri-terminal-box-line',className:'terminal-window',width:600,height:400,appId:'terminal',
              content:`<div class="terminal-content"><div class="terminal-input-line"><span class="terminal-prompt"></span><input class="terminal-input" type="text"></div></div>`});
            const content=win.element.querySelector('.terminal-content');
            const input=content.querySelector('.terminal-input');
            const prompt=content.querySelector('.terminal-prompt');
            const print=t=>{ const d=document.createElement('div'); d.textContent=t; content.insertBefore(d, content.querySelector('.terminal-input-line')); };
            const updatePrompt=()=>{ prompt.textContent=`user@minios:~/${dir.split('/').pop()}$ `; };
            function exec(cmd){
              const [c,...a]=cmd.trim().split(' ');
              print(`${prompt.textContent}${cmd}`);
              switch(c){
                case 'ls':{
                  const item=utils.findItemByPath(dir);
                  if(item && item.type==='folder') print(Object.keys(item.children).join('  '));
                  else print('ls: error'); break;
                }
                case 'cd':{
                  const p=a[0]; if(!p) break;
                  if(p==='..'){ if(dir!=='Desktop') dir=dir.substring(0,dir.lastIndexOf('/')); }
                  else {
                    const target=p.startsWith('Desktop')?p:`${dir}/${p}`;
                    const t=utils.findItemByPath(target);
                    if(t && t.type==='folder') dir=target; else print(`cd: no such directory: ${p}`);
                  } break;
                }
                case 'cat':{
                  const f=utils.findItemByPath(`${dir}/${a[0]}`);
                  if(f && f.type==='file') print(f.content); else print(`cat: no such file: ${a[0]}`); break;
                }
                case 'mkdir': if(a[0]){ utils.createFolder(dir,a[0]); print(`Created directory: ${a[0]}`);} break;
                case 'touch': if(a[0]){ utils.createFile(dir,a[0]); print(`Created file: ${a[0]}`);} break;
                case 'rm': if(a[0]){ if(utils.deleteItem(`${dir}/${a[0]}`)) print(`Removed ${a[0]}`); else print(`rm: cannot remove ${a[0]}`); } break;
                case 'clear': Array.from(content.children).forEach(c=>{ if(!c.classList.contains('terminal-input-line')) c.remove(); }); break;
                case 'pwd': print('/'+dir); break;
                case 'open':{
                  if(!a[0]){ print("open: missing name"); break; }
                  const target=`${dir}/${a[0]}`; const it=utils.findItemByPath(target);
                  if(it){
                    if(it.type==='folder') appManager.launch('explorer',target);
                    else if(it.type==='file') appManager.launch('editor',target);
                    else if(it.type==='app') appManager.launch(it.appId);
                    else if(it.type==='link') appManager.launch('browser',it.url);
                    print(`Opened ${a[0]}`);
                  } else print(`open: not found: ${a[0]}`);
                  break;
                }
                case 'help': print('Commands: ls, cd, cat, mkdir, touch, rm, pwd, clear, open, help'); break;
                default: if(cmd.trim()) print(`command not found: ${cmd}`);
              }
              updatePrompt(); content.scrollTop=content.scrollHeight;
            }
            input.onkeydown=e=>{
              if(e.key==='Enter'){ const cmd=input.value; if(cmd){hist.push(cmd); hIdx=hist.length;} exec(cmd); input.value=''; }
              else if(e.key==='ArrowUp'){ if(hIdx>0){ hIdx--; input.value=hist[hIdx]; } }
              else if(e.key==='ArrowDown'){ if(hIdx<hist.length-1){ hIdx++; input.value=hist[hIdx]; } else { hIdx=hist.length; input.value=''; } }
            };
            updatePrompt(); input.focus(); content.onclick=()=>input.focus();
          }
        },
        help:{
          launch:()=>{
            windowManager.create({title:'Help',icon:'ri-question-line',className:'help-window',width:600,height:500,appId:'help',
              content:`<div style="padding:20px;overflow:auto;font-size:14px;line-height:1.5;">
                <h2 style="margin-top:0;">Mini OS Help</h2>
                <p>Desktop icons, files, editors, music, terminal & bookmarks.</p>
                <h3><i class="ri-cloud-line"></i> Cloud Sync</h3><p>Signed in => synced; Guest => local only.</p>
                <h3><i class="ri-file-code-line"></i> Editors</h3>
                <ul style="padding-left:18px;margin:6px 0 14px;">
                  <li>Line numbers & tabs</li><li>Unsaved indicator (*)</li><li>HTML live preview</li>
                </ul>
                <h3><i class="ri-timer-line"></i> Autosave</h3><p>Active 5m, idle 10m, manual Save button (2m cooldown).</p>
                <h3><i class="ri-window-line"></i> Browser Session</h3><p>Open browser windows are restored after reload.</p>
                <h3><i class="ri-layout-grid-line"></i> Icon Reflow</h3><p>Icons reflow available via Settings or Desktop menu.</p>
              </div>`});
          }
        },
        calculator:{
          launch:()=>{
            const win=windowManager.create({title:'Calculator',icon:'ri-calculator-line',className:'calculator-window',width:320,height:470,appId:'calculator',
              content:`<div class="calc-display" id="calc-display">0</div>
                <div class="calc-buttons">
                  <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button class="operator" data-op="/">/</button>
                  <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button class="operator" data-op="*">*</button>
                  <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button class="operator" data-op="-">-</button>
                  <button data-key="0">0</button><button data-key=".">.</button><button class="clear" data-clear="C">C</button><button class="operator" data-op="+">+</button>
                  <button class="equal" data-eq="=">=</button>
                </div>`});
            const display=win.element.querySelector('#calc-display');
            let current='0',stored=null,op=null,just=false;
            const render=()=>display.textContent=current;
            const digit=d=>{ if(just){current='0';just=false;} if(d==='.') { if(!current.includes('.')) current+='.'; return render(); } current=(current==='0')?d:current+d; render(); };
            const clear=()=>{ current='0'; stored=null; op=null; just=false; render(); }
            const apply=o=>{ if(op && stored!=null && !just) compute(); else stored=parseFloat(current); op=o; current='0'; just=false; }
            const compute=()=>{ if(op && stored!=null){ const a=stored,b=parseFloat(current); let r=0; switch(op){case '+':r=a+b;break;case '-':r=a-b;break;case '*':r=a*b;break;case '/':r=b===0?0:a/b;break;} current=(r.toString().length>14?r.toPrecision(10):r.toString()); stored=r; op=null; just=true; render(); } }
            win.element.querySelector('.calc-buttons').onclick=e=>{
              const b=e.target.closest('button'); if(!b) return;
              if(b.dataset.key) digit(b.dataset.key);
              else if(b.dataset.op) apply(b.dataset.op);
              else if(b.dataset.eq) compute();
              else if(b.dataset.clear) clear();
            };
            window.addEventListener('keydown',e=>{
              if(!win.element.parentNode) return;
              if(/^[0-9]$/.test(e.key)) digit(e.key);
              else if(e.key==='.') digit('.');
              else if(['+','-','*','/'].includes(e.key)) apply(e.key);
              else if(e.key==='Enter'){ e.preventDefault(); compute(); }
              else if(e.key==='Escape') clear();
            });
            render();
          }
        },
        settings:{
          launch:()=>{
            const win=windowManager.create({title:'Settings',icon:'ri-settings-3-line',className:'settings-window',width:620,height:560,appId:'settings'});
            const content=win.element.querySelector('.window-content');
            content.innerHTML=`
              <div class="settings-section">
                <h3>Desktop Background</h3>
                <p>Select a preset:</p>
                <div id="bg-options-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;"></div>
                <p style="margin-top:10px;">Custom URL:</p>
                <input type="text" id="custom-bg-url" placeholder="https://example.com/image.jpg">
                <button id="set-custom-bg-btn">Set Background</button>
              </div>
              <div class="settings-section">
                <h3>Add Desktop Icons</h3>
                <p>Add an application shortcut.</p>
                <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
                  <select id="add-app-select" style="flex:1;padding:8px;"></select>
                  <button id="add-app-btn">Add</button>
                </div>
              </div>
              <div class="settings-section">
                <h3>System</h3>
                <p>Reset or reflow desktop layout.</p>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                  <button id="reset-desktop-btn" style="background:var(--error);color:#fff;">Reset Desktop</button>
                  <button id="reflow-desktop-btn" style="background:var(--primary);color:#fff;">Reflow Icons</button>
                </div>
              </div>
              <div class="settings-section">
                <h3>Profile Data (Export / Import)</h3>
                <p>Backup or restore your profile.</p>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                  <button id="export-profile-btn" style="flex:1;">Download JSON</button>
                  <button id="import-profile-btn" style="flex:1;">Import JSON</button>
                  <input type="file" id="import-file-input" accept="application/json" style="display:none;">
                </div>
                <small>Import replaces current state.</small>
              </div>`;
            const bgGrid=content.querySelector('#bg-options-grid');
            config.backgroundOptions.forEach(bg=>{
              const d=document.createElement('div');
              d.style.cssText=`aspect-ratio:16/9;background-size:cover;background-position:center;background-image:url('${bg.url}');border:2px solid ${state.background===bg.url?'var(--primary)':'transparent'};border-radius:8px;cursor:pointer;`;
              if(state.background===bg.url) d.classList.add('selected');
              d.onclick=()=>core.setBackground(bg.url,bgGrid);
              bgGrid.appendChild(d);
            });
            content.querySelector('#set-custom-bg-btn').onclick=()=>{
              const url=content.querySelector('#custom-bg-url').value.trim();
              if(url) core.setBackground(url,bgGrid);
            };
            const addSel=content.querySelector('#add-app-select');
            const addBtn=content.querySelector('#add-app-btn');
            function populate(){
              addSel.innerHTML='';
              const present=Object.keys(state.fileSystem.Desktop.children);
              const available=Object.keys(defaultDesktopItems).filter(k=>defaultDesktopItems[k].type==='app' && !present.includes(k));
              if(!available.length){addSel.innerHTML='<option>No apps available</option>'; addBtn.disabled=true;}
              else { available.forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; addSel.appendChild(o); }); addBtn.disabled=false; }
            }
            addBtn.onclick=()=>{
              const n=addSel.value;
              if(n && defaultDesktopItems[n]){
                state.fileSystem.Desktop.children[n]=JSON.parse(JSON.stringify(defaultDesktopItems[n]));
                desktopManager.createIcon(n,state.fileSystem.Desktop.children[n]);
                utils.saveState({});
                utils.showNotification("Added "+n,"success");
                populate();
              }
            };
            populate();
            content.querySelector('#reset-desktop-btn').onclick=()=>{
              if(confirm("Reset desktop?")){
                state.fileSystem.Desktop.children=JSON.parse(JSON.stringify(defaultDesktopItems));
                state.iconPositions={};
                utils.saveState({immediate:true});
                desktopManager.renderIcons();
                desktopManager.reflowDesktop(true);
                utils.showNotification("Desktop reset.","success");
                populate();
              }
            };
            content.querySelector('#reflow-desktop-btn').onclick=()=>{ desktopManager.reflowDesktop(true); utils.showNotification("Icons reflowed.","info"); };
            const exportBtn=content.querySelector('#export-profile-btn');
            const importBtn=content.querySelector('#import-profile-btn');
            const importInput=content.querySelector('#import-file-input');
            exportBtn.onclick=()=>exportProfile();
            importBtn.onclick=()=>importInput.click();
            importInput.onchange=e=>{
              const file=e.target.files[0]; if(!file) return;
              const r=new FileReader(); r.onload=()=>importProfileData(r.result); r.readAsText(file);
            };
          }
        },
        browser:{
          launch:(url)=>{
            const win=windowManager.create({title:'Browser',icon:'ri-global-line',appId:'browser',
              width:config.defaultWindowSize.width,height:config.defaultWindowSize.height,
              refreshable:true,fullscreenable:true,
              content:`<iframe src="${url}" style="width:100%;height:100%;border:none;"></iframe>`});
            snapshotOpenBrowserWindows();
          }
        },
        bookmarks:{ launch:()=>core.toggleBookmarksOverlay() },
        clock:{
          launch:()=>{
            let clockInterval,timerInterval;
            const win=windowManager.create({title:'Clock',icon:'ri-time-line',className:'clock-window',width:420,height:470,appId:'clock',
              onClose:()=>{clearInterval(clockInterval); clearInterval(timerInterval);},
              content:`<div class="clock-tabs">
                <div class="clock-tab active" data-tab="clock">Clock</div>
                <div class="clock-tab" data-tab="timer">Timer</div>
                <div class="clock-tab" data-tab="alarm">Alarm</div>
              </div>
              <div id="clock-panel" class="clock-panel active">
                <div id="clock-display" style="font-size:3.1em;text-align:center;margin-top:14px;"></div>
                <div id="date-display" style="text-align:center;margin-top:6px;font-size:13px;"></div>
              </div>
              <div id="timer-panel" class="clock-panel">
                <div id="timer-display" style="display:none;font-size:2.2em;text-align:center;margin:10px 0;">00:05:00</div>
                <div class="timer-inputs" style="display:flex;justify-content:center;gap:8px;margin-top:12px;">
                  <input type="number" id="timer-h" value="0" min="0" style="width:70px;"> :
                  <input type="number" id="timer-m" value="5" min="0" max="59" style="width:70px;"> :
                  <input type="number" id="timer-s" value="0" min="0" max="59" style="width:70px;">
                </div>
                <div style="text-align:center;margin-top:10px;">
                  <button id="timer-start">Start</button>
                  <button id="timer-pause" style="display:none;">Pause</button>
                  <button id="timer-reset">Reset</button>
                </div>
              </div>
              <div id="alarm-panel" class="clock-panel">
                <div style="text-align:center;display:flex;gap:8px;justify-content:center;">
                  <input type="time" id="alarm-time">
                  <button id="set-alarm-btn">Set</button>
                </div>
                <div id="alarms-list" style="margin-top:16px;"></div>
              </div>`});
            const c=win.element.querySelector('.window-content');
            const clk=c.querySelector('#clock-display');
            const dateEl=c.querySelector('#date-display');
            const update=()=>{ const now=new Date(); clk.textContent=now.toLocaleTimeString(); dateEl.textContent=now.toLocaleDateString(undefined,{weekday:'long',year:'numeric',month:'long',day:'numeric'}); };
            clockInterval=setInterval(update,1000); update();
            c.querySelectorAll('.clock-tab').forEach(t=>{
              t.onclick=()=>{ c.querySelector('.clock-tab.active').classList.remove('active'); t.classList.add('active'); c.querySelector('.clock-panel.active').classList.remove('active'); c.querySelector('#'+t.dataset.tab+'-panel').classList.add('active'); };
            });
            // Timer
            const disp=c.querySelector('#timer-display'), inputs=c.querySelector('.timer-inputs');
            const h=c.querySelector('#timer-h'), m=c.querySelector('#timer-m'), s=c.querySelector('#timer-s');
            const start=c.querySelector('#timer-start'), pause=c.querySelector('#timer-pause'), reset=c.querySelector('#timer-reset');
            let total=0, paused=false;
            const show=()=>{ const H=Math.floor(total/3600), M=Math.floor((total%3600)/60), S=total%60; disp.textContent=`${String(H).padStart(2,'0')}:${String(M).padStart(2,'0')}:${String(S).padStart(2,'0')}`; };
            start.onclick=()=>{
              if(paused) paused=false; else total=parseInt(h.value)*3600+parseInt(m.value)*60+parseInt(s.value);
              if(total<=0) return;
              show();
              timerInterval=setInterval(()=>{
                if(paused) return;
                total--; show();
                if(total<=0){ clearInterval(timerInterval); utils.showNotification("Timer finished!","success"); elements.alarmSound.loop=false; elements.alarmSound.play(); reset.click(); }
              },1000);
              start.style.display='none'; pause.style.display='inline-block'; disp.style.display='block'; inputs.style.display='none';
            };
            pause.onclick=()=>{ paused=true; start.textContent='Resume'; start.style.display='inline-block'; pause.style.display='none'; };
            reset.onclick=()=>{ clearInterval(timerInterval); total=0; paused=false; show(); start.textContent='Start'; start.style.display='inline-block'; pause.style.display='none'; disp.style.display='none'; inputs.style.display='flex'; };
            // Alarms
            const setBtn=c.querySelector('#set-alarm-btn'); const alarmTime=c.querySelector('#alarm-time'); const list=c.querySelector('#alarms-list');
            const render=()=>{ list.innerHTML=''; state.alarms.forEach((a,i)=>{ const d=document.createElement('div'); d.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:#fff;border-radius:8px;margin-bottom:8px;font-size:13px;'; d.innerHTML=`<span>${a.time}</span><button data-i="${i}" style="background:#ef4444;color:#fff;border:none;border-radius:4px;padding:2px 6px;cursor:pointer;font-size:12px;">&times;</button>`; list.appendChild(d); }); };
            list.onclick=e=>{ if(e.target.tagName==='BUTTON'){ state.alarms.splice(e.target.dataset.i,1); utils.saveState({}); render(); } };
            setBtn.onclick=()=>{ if(!alarmTime.value) return; state.alarms.push({time:alarmTime.value,lastTriggeredDay:null}); utils.saveState({}); render(); };
            render();
          }
        }
      }
    };

    /**************** Desktop Manager (bounded icon drag) ****************/
    const desktopManager = {
      init(){
        elements.desktop.addEventListener('contextmenu',e=>desktopManager.showContextMenu(e,'desktop'));
        elements.desktop.addEventListener('mousedown',e=>desktopManager.onMouseDown(e));
        desktopManager.renderIcons();
        desktopManager.fixOverlapsOnLoad();
      },
      renderIcons(){
        elements.desktopIcons.innerHTML='';
        const items=state.fileSystem.Desktop.children;
        Object.entries(items).forEach(([n,it])=>desktopManager.createIcon(n,it));
      },
      createIcon(name,item){
        const path=`Desktop/${name}`;
        const div=document.createElement('div');
        div.className='desktop-icon';
        div.dataset.path=path;
        const cls=item.type==='folder'?'ri-folder-3-line':(item.type==='app'?item.icon:utils.getIconForFile(name,item));
        div.innerHTML=`<i class="${cls}"></i><div class="desktop-icon-name">${name}</div>`;
        if(!state.iconPositions[path]){
          const {top,left}=desktopManager.nextPos();
          state.iconPositions[path]={top,left};
          utils.saveState({});
        }
        const pos=state.iconPositions[path];
        div.style.top=pos.top+'px';
        div.style.left=pos.left+'px';
        div.addEventListener('mousedown',e=>desktopManager.onIconMouseDown(e,div));
        div.addEventListener('contextmenu',e=>desktopManager.showContextMenu(e,'icon',div));
        elements.desktopIcons.appendChild(div);
      },
      nextPos(){
        const occ=new Set(Object.values(state.iconPositions).map(p=>`${p.left},${p.top}`));
        const w=elements.desktopIcons.clientWidth;
        const h=elements.desktopIcons.clientHeight;
        for(let y=0;y<=h-config.gridSize;y+=config.gridSize){
          for(let x=0;x<=w-config.gridSize;x+=config.gridSize){
            if(!occ.has(`${x},${y}`)) return {top:y,left:x};
          }
        }
        return {top:0,left:0};
      },
      fixOverlapsOnLoad(){
        const used=new Set(); let changed=false;
        Object.keys(state.iconPositions).forEach(path=>{
          const pos=state.iconPositions[path];
          const key=`${pos.left},${pos.top}`;
          if(used.has(key)){
            const {top,left}=desktopManager.nextPos();
            state.iconPositions[path]={top,left}; changed=true;
          } else used.add(key);
        });
        if(changed){ utils.saveState({}); desktopManager.renderIcons(); }
      },
      reflowDesktop(force=false){
        const items=Object.keys(state.fileSystem.Desktop.children).sort((a,b)=>a.localeCompare(b));
        state.iconPositions={};
        const w=elements.desktopIcons.clientWidth;
        const h=elements.desktopIcons.clientHeight;
        let x=0,y=0;
        items.forEach(name=>{
          state.iconPositions[`Desktop/${name}`]={top:y,left:x};
          y+=config.gridSize;
          if(y+config.gridSize>h){ y=0; x+=config.gridSize; }
          if(x+config.gridSize>w){ x=0; } // wrap if needed
        });
        utils.saveState({});
        desktopManager.renderIcons();
        if(force) utils.showNotification("Desktop icons reflowed.","info");
      },
      onMouseDown(e){
        if(e.target!==elements.desktopIcons && e.target!==elements.desktop) return;
        desktopManager.clearSelected();
        const sx=e.clientX, sy=e.clientY;
        const rect=elements.desktop.getBoundingClientRect();
        Object.assign(elements.selectionBox.style,{left:(sx-rect.left)+'px',top:(sy-rect.top)+'px',width:'0px',height:'0px',display:'block'});
        const move=me=>{
          const cx=me.clientX,cy=me.clientY;
          const w=Math.abs(cx-sx), h=Math.abs(cy-sy);
          const nx=Math.min(sx,cx)-rect.left, ny=Math.min(sy,cy)-rect.top;
          Object.assign(elements.selectionBox.style,{left:nx+'px',top:ny+'px',width:w+'px',height:h+'px'});
          const box=elements.selectionBox.getBoundingClientRect();
          document.querySelectorAll('.desktop-icon').forEach(ic=>{
            const r=ic.getBoundingClientRect();
            const over=r.left<box.right && r.right>box.left && r.top<box.bottom && r.bottom>box.top;
            ic.classList.toggle('selected',over);
          });
        };
        const up=()=>{ elements.selectionBox.style.display='none'; state.selectedIcons=new Set(document.querySelectorAll('.desktop-icon.selected')); document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); };
        document.addEventListener('mousemove',move);
        document.addEventListener('mouseup',up);
      },
      onIconMouseDown(e,icon){
        e.stopPropagation();
        let drag=false; const thresh=5;
        if(!e.ctrlKey && !icon.classList.contains('selected')) desktopManager.clearSelected();
        if(e.ctrlKey) icon.classList.toggle('selected'); else icon.classList.add('selected');
        state.selectedIcons=new Set(document.querySelectorAll('.desktop-icon.selected'));
        const starts=Array.from(state.selectedIcons).map(el=>({el,x:el.offsetLeft,y:el.offsetTop,w:el.offsetWidth,h:el.offsetHeight}));
        const sx=e.clientX, sy=e.clientY;
        const deskW=elements.desktopIcons.clientWidth;
        const deskH=elements.desktopIcons.clientHeight;
        const move=me=>{
          if(!drag && (Math.abs(me.clientX-sx)>thresh || Math.abs(me.clientY-sy)>thresh)){ drag=true; icon.ondblclick=null; }
          if(drag){
            const dx=me.clientX-sx, dy=me.clientY-sy;
            starts.forEach(p=>{
              let nl=p.x+dx, nt=p.y+dy;
              nl=clamp(nl,0, deskW-p.w);
              nt=clamp(nt,0, deskH-p.h);
              p.el.style.left=nl+'px';
              p.el.style.top=nt+'px';
            });
          }
        };
        const up=()=>{
          document.removeEventListener('mousemove',move);
          document.removeEventListener('mouseup',up);
          if(drag){
            starts.forEach(p=>{
              const w=elements.desktopIcons.clientWidth;
              const h=elements.desktopIcons.clientHeight;
              let finalLeft=Math.round(p.el.offsetLeft/config.gridSize)*config.gridSize;
              let finalTop =Math.round(p.el.offsetTop /config.gridSize)*config.gridSize;
              finalLeft=clamp(finalLeft,0, w-p.w);
              finalTop =clamp(finalTop ,0, h-p.h);
              p.el.style.left=finalLeft+'px';
              p.el.style.top =finalTop +'px';
              state.iconPositions[p.el.dataset.path]={top:finalTop,left:finalLeft};
            });
            utils.saveState({});
          }
          icon.ondblclick=()=>{ const item=utils.findItemByPath(icon.dataset.path); desktopManager.onIconDoubleClick(item,icon.dataset.path); };
        };
        icon.ondblclick=()=>{ document.removeEventListener('mousemove',move); document.removeEventListener('mouseup',up); const item=utils.findItemByPath(icon.dataset.path); desktopManager.onIconDoubleClick(item,icon.dataset.path); };
        document.addEventListener('mousemove',move);
        document.addEventListener('mouseup',up);
      },
      onIconDoubleClick(item,path){
        const ext=path.split('.').pop().toLowerCase();
        if(item.type==='app') appManager.launch(item.appId,path);
        else if(item.type==='folder') appManager.launch('explorer',path);
        else if(item.type==='link') appManager.launch('browser',item.url);
        else if(['jpg','jpeg','png','gif'].includes(ext)) appManager.launch('imageViewer',path);
        else if(['mp3','wav','ogg'].includes(ext)) utils.showNotification("Open music files via Music Player.","info");
        else if(item.type==='file') appManager.launch('editor',path);
      },
      clearSelected(){
        document.querySelectorAll('.desktop-icon.selected').forEach(i=>i.classList.remove('selected'));
        state.selectedIcons.clear();
      },
      showContextMenu(e,type,target){
        e.preventDefault(); e.stopPropagation();
        let menu='';
        const path=target?.dataset?.path;
        const item=path?utils.findItemByPath(path):null;
        switch(type){
          case 'desktop':
            menu=`<div class="context-item" data-action="create-folder"><i class="ri-folder-add-line"></i>New Folder</div>
              <div class="context-item" data-action="create-file"><i class="ri-file-add-line"></i>New Text File</div>
              <div class="context-item" data-action="create-link"><i class="ri-link"></i>New Link</div>
              <div class="context-item" data-action="reflow"><i class="ri-layout-grid-line"></i>Reflow Icons</div>`;
            break;
          case 'icon':
            if(item){
              menu=`<div class="context-item" data-action="open"><i class="ri-arrow-right-up-line"></i>Open</div>`;
              if(item.type!=='app'){
                menu+=`<div class="context-item" data-action="rename"><i class="ri-pencil-line"></i>Rename</div>
                  <div class="context-item" data-action="delete"><i class="ri-delete-bin-line"></i>Delete</div>`;
              }
            }
            break;
          case 'start':
            menu=Object.keys(defaultDesktopItems).map(n=>({name:n,...defaultDesktopItems[n]}))
              .filter(i=>i.type==='app').map(a=>`<div class="context-item" data-action="launch-app" data-appid="${a.appId}"><i class="${a.icon}"></i>${a.name}</div>`).join('');
            break;
          case 'explorer-bg':
            menu=`<div class="context-item" data-action="create-folder-here"><i class="ri-folder-add-line"></i>New Folder</div>
              <div class="context-item" data-action="create-file-here"><i class="ri-file-add-line"></i>New Text File</div>
              <div class="context-item" data-action="create-file-from-url"><i class="ri-download-cloud-2-line"></i>New File from URL</div>`;
            break;
        }
        elements.contextMenu.innerHTML=menu;
        elements.contextMenu.style.display='block';
        const menuRect=elements.contextMenu.getBoundingClientRect();
        const tRect=target instanceof Element?target.getBoundingClientRect():{top:e.clientY,left:e.clientX};
        let top=e.clientY,left=e.clientX;
        if(type==='start'){ top=tRect.top - menuRect.height - 10; left=tRect.left; }
        elements.contextMenu.style.top=top+'px';
        elements.contextMenu.style.left=left+'px';
        elements.contextMenu.onclick=ce=>{
          const ct=ce.target.closest('.context-item'); if(!ct) return;
          desktopManager.handleContextAction(ct.dataset.action,target,ce);
          elements.contextMenu.style.display='none';
        };
      },
      handleContextAction(action,target,event){
        const path=target?.dataset?.path;
        const item=path?utils.findItemByPath(path):null;
        switch(action){
          case 'create-folder': utils.createFolder('Desktop','New Folder'); desktopManager.renderIcons(); break;
          case 'create-file': utils.createFile('Desktop','New File.txt'); desktopManager.renderIcons(); break;
          case 'create-link':{
            const url=prompt("Enter URL:"); if(url){
              const name=prompt("Link name:","My Link");
              if(name){ utils.createLink('Desktop',name,url); desktopManager.renderIcons(); }
            } break;
          }
          case 'reflow': desktopManager.reflowDesktop(true); break;
          case 'create-folder-here':{
            const name=prompt("Folder name:","New Folder");
            if(name){ utils.createFolder(target.path,name); appManager.apps.explorer.render(target.win,target.path); }
            break;
          }
          case 'create-file-here':{
            const name=prompt("File name:","New File.txt");
            if(name){ utils.createFile(target.path,name); appManager.apps.explorer.render(target.win,target.path); }
            break;
          }
          case 'create-file-from-url':{
            const fUrl=prompt("Direct file URL:"); if(fUrl){
              const n=prompt("File name (e.g. image.jpg):");
              if(n){ utils.createFile(target.path,n,fUrl); appManager.apps.explorer.render(target.win,target.path); }
            } break;
          }
          case 'open': if(item) desktopManager.onIconDoubleClick(item,path); break;
          case 'delete':
            if(confirm(`Delete ${path.split('/').pop()}?`)){
              if(utils.deleteItem(path)) target.remove();
            } break;
          case 'rename':{
            const nameEl=target.querySelector('.desktop-icon-name');
            nameEl.contentEditable='true'; nameEl.classList.add('editing'); nameEl.focus();
            document.execCommand('selectAll',false,null);
            state.isRenaming=true;
            const finish=()=>{
              nameEl.contentEditable='false'; nameEl.classList.remove('editing');
              document.removeEventListener('click',outside,true);
              nameEl.removeEventListener('keydown',key);
              const newName=nameEl.textContent.trim();
              if(utils.renameItem(path,newName)){ target.dataset.path=path.substring(0,path.lastIndexOf('/')+1)+newName; }
              else nameEl.textContent=path.split('/').pop();
              state.isRenaming=false;
            };
            const outside=e=>{ if(!nameEl.contains(e.target)) finish(); };
            const key=e=>{ if(e.key==='Enter'){ e.preventDefault(); finish(); } else if(e.key==='Escape'){ nameEl.textContent=path.split('/').pop(); finish(); } };
            setTimeout(()=>{ document.addEventListener('click',outside,true); nameEl.addEventListener('keydown',key); },0);
            break;
          }
          case 'launch-app': appManager.launch(event.target.closest('.context-item').dataset.appid); break;
        }
      }
    };

    /**************** Core ****************/
    const core = {
      init(){
        elements.desktop.style.backgroundImage=`url('${state.background}')`;
        utils.updateClock(); setInterval(utils.updateClock,1000);
        setInterval(core.checkAlarms,1000);
        desktopManager.init();
        core.bindEvents();
        core.renderBookmarks();
        if(!localStorage.getItem('hasVisited')) localStorage.setItem('hasVisited','true');
        const overlay=document.getElementById('loading-overlay'); if(overlay) setTimeout(()=>overlay.remove(),450);
        showAuthModal(true);
        setupManualSave();
        setupAutosave();
        restoreBrowserWindows();
      },
      bindEvents(){
        elements.startBtn.addEventListener('click',e=>desktopManager.showContextMenu(e,'start',elements.startBtn));
        document.addEventListener('click',e=>{
          if(!elements.contextMenu.contains(e.target)) elements.contextMenu.style.display='none';
          if(!e.target.closest('.desktop-icon') && !state.isRenaming) desktopManager.clearSelected();
        });
        elements.contextMenu.addEventListener('click',e=>e.stopPropagation());
        elements.bookmarksBtn.addEventListener('click',core.toggleBookmarksOverlay);
        elements.closeBookmarks.addEventListener('click',core.toggleBookmarksOverlay);
        elements.bookmarksOverlay.querySelectorAll('.bookmark-select').forEach(sel=>{
          sel.onchange=e=>{ const url=e.target.value; if(url){ appManager.launch('browser',url); core.toggleBookmarksOverlay(); e.target.value=''; } };
        });
        elements.addBookmarkForm.addEventListener('submit',e=>{
          e.preventDefault();
          const name=e.target['new-bookmark-name'].value.trim();
          let url=e.target['new-bookmark-url'].value.trim();
          if(name && url){
            if(!/^https?:\/\//i.test(url)) url='https://'+url;
            state.bookmarks.push({name,url});
            utils.saveState({});
            core.renderBookmarks();
            e.target.reset();
          }
        });
        elements.customBookmarksList.addEventListener('click',e=>{
          const del=e.target.closest('.delete-bookmark');
          if(del){ const idx=parseInt(del.dataset.index,10); state.bookmarks.splice(idx,1); utils.saveState({}); core.renderBookmarks(); }
          else {
            const bm=e.target.closest('.bookmark-item');
            if(bm && bm.dataset.url){ appManager.launch('browser',bm.dataset.url); core.toggleBookmarksOverlay(); }
          }
        });
        elements.goBtn.addEventListener('click',()=>{
          let url=elements.urlInput.value.trim();
          if(url){ if(!/^https?:\/\//i.test(url)) url='https://'+url; appManager.launch('browser',url); }
        });
        elements.homeBtn.addEventListener('click',()=>appManager.launch('browser',config.defaultUrl));
        elements.alarmStopBtn.addEventListener('click',()=>{
          elements.alarmModal.style.display='none';
          elements.alarmSound.pause(); elements.alarmSound.currentTime=0;
        });
      },
      toggleBookmarksOverlay(){
        elements.bookmarksOverlay.style.display=elements.bookmarksOverlay.style.display==='flex'?'none':'flex';
        if(elements.bookmarksOverlay.style.display==='none'){
          const n=document.getElementById('new-bookmark-name'); const u=document.getElementById('new-bookmark-url');
          if(n) n.value=''; if(u) u.value='';
        }
      },
      renderBookmarks(){
        elements.customBookmarksList.innerHTML='';
        state.bookmarks.forEach((bm,i)=>{
          const d=document.createElement('div');
          d.className='bookmark-item';
          d.dataset.url=bm.url;
          d.innerHTML=`<span>${bm.name}</span><button class="delete-bookmark" data-index="${i}"><i class="ri-close-line"></i></button>`;
          elements.customBookmarksList.appendChild(d);
        });
      },
      checkAlarms(){
        if(elements.alarmModal.style.display==='flex') return;
        const now=new Date();
        const day=now.getDay();
        const time=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        state.alarms.forEach(al=>{
          if(al.time===time && al.lastTriggeredDay!==day){
            elements.alarmModal.style.display='flex';
            elements.alarmSound.loop=true; elements.alarmSound.play();
            al.lastTriggeredDay=day; utils.saveState({});
          }
        });
      },
      setBackground(url,grid){
        state.background=url;
        elements.desktop.style.backgroundImage=`url('${url}')`;
        utils.saveState({});
        if(grid){
          grid.querySelector('.selected')?.classList.remove('selected');
          const match=Array.from(grid.children).find(c=>c.style.backgroundImage.includes(url));
          if(match) match.classList.add('selected');
        }
      },
      updateTaskbar(){
        elements.taskbarApps.innerHTML='';
        state.windows.forEach(w=>{
          const btn=document.createElement('button');
          btn.className='taskbar-item';
          if(w.id===state.activeWindow && !w.isMinimized) btn.classList.add('active');
          btn.innerHTML=`<i class="${w.icon}"></i><span>${w.title}</span>`;
          btn.onclick=()=>{
            if(w.isMinimized) windowManager.restore(w.id);
            else if(state.activeWindow===w.id) windowManager.minimize(w.id);
            else windowManager.activate(w.id);
            snapshotOpenBrowserWindows();
          };
          elements.taskbarApps.appendChild(btn);
        });
      }
    };

    function applyStateToUI(){
      elements.desktop.style.backgroundImage=`url('${state.background}')`;
      desktopManager.renderIcons();
      core.renderBookmarks();
    }

    /**************** Manual Save & Autosave ****************/
    const MANUAL_SAVE_COOLDOWN_MS=2*60*1000;
    let lastManualSave=0, manualTimer=null;
    function updateManualButton(){
      const btn=elements.manualSaveBtn;
      const remain=lastManualSave + MANUAL_SAVE_COOLDOWN_MS - Date.now();
      btn.querySelector('.cooldown-badge')?.remove();
      if(remain>0){
        btn.disabled=true;
        const badge=document.createElement('span');
        badge.className='cooldown-badge';
        badge.textContent=Math.ceil(remain/1000)+'s';
        btn.appendChild(badge);
      } else btn.disabled=false;
    }
    function setupManualSave(){
      updateManualButton();
      elements.manualSaveBtn.addEventListener('click',()=>{
        const now=Date.now();
        if(now - lastManualSave < MANUAL_SAVE_COOLDOWN_MS){ updateManualButton(); return; }
        lastManualSave=now;
        utils.saveState({immediate:true});
        utils.showNotification("Desktop saved.","success");
        updateManualButton();
        if(manualTimer) clearInterval(manualTimer);
        manualTimer=setInterval(()=>{
          updateManualButton();
          if(!elements.manualSaveBtn.disabled){ clearInterval(manualTimer); manualTimer=null; }
        },1000);
      });
    }

    const IDLE_THRESHOLD_MS=90*1000;
    const ACTIVE_INTERVAL_MS=5*60*1000;
    const IDLE_INTERVAL_MS=10*60*1000;
    let lastActivity=Date.now(), lastAutoSave=Date.now();
    function setupAutosave(){
      const mark=()=>lastActivity=Date.now();
      ['mousemove','keydown','click','scroll','touchstart'].forEach(ev=>window.addEventListener(ev,mark,{passive:true}));
      setInterval(()=>{
        const now=Date.now();
        const idle=(now - lastActivity) > IDLE_THRESHOLD_MS;
        const interval= idle ? IDLE_INTERVAL_MS : ACTIVE_INTERVAL_MS;
        if(now - lastAutoSave >= interval){
          lastAutoSave=now;
          utils.saveState({immediate:true});
          utils.showNotification(idle ? "Idle autosave complete." : "Active autosave complete.","info");
        }
      }, 30000);
    }

    /**************** Auth State Listener ****************/
    onAuthStateChanged(auth, async (user)=>{
      cloudUser=user;
      if(user){
        userBadge.style.display='flex';
        if(user.isAnonymous){
          userLabel.textContent='Guest (local only)';
          showAuthModal(false);
          applyStateToUI();
          if(unsubscribeUserDoc){ unsubscribeUserDoc(); unsubscribeUserDoc=null; }
        } else {
          userLabel.textContent=user.email || user.displayName || user.uid.slice(0,8);
          showAuthModal(false);
          await loadCloudState(user.uid);
        }
      } else {
        if(unsubscribeUserDoc){ unsubscribeUserDoc(); unsubscribeUserDoc=null; }
        userBadge.style.display='none';
        showAuthModal(true);
      }
    });

    /**************** Init ****************/
    function start(){ core.init(); }
    if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',start); else start();

    window.miniOSState = state;
  </script>
</body>
</html>
