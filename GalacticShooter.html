<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Galactic Shooter: Ultimate</title>

    <style>
      /* Layout and base styles */
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        background: #000;
        font-family: Arial, sans-serif;
      }

      #gameCanvas {
        display: block;
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
      }

      /* HUD/UI */
      #ui {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #fff;
        font-size: 16px;
        text-shadow: 0 0 5px #0ff;
        pointer-events: none;
        z-index: 100;
      }

      #score,
      #highScore,
      #level,
      #xp,
      #zone,
      #money {
        margin: 5px 0;
      }

      #healthBar {
        width: 200px;
        height: 10px;
        background: rgba(255, 0, 0, 0.3);
        margin: 5px 0;
        border-radius: 5px;
        overflow: hidden;
      }

      #healthFill {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #00ff00, #00ff88);
        transition: width 0.3s;
      }

      /* Overlays */
      #upgradeScreen,
      #shopScreen,
      #shipSelectScreen {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        color: #fff;
      }

      .menu-title {
        font-size: 36px;
        color: #0ff;
        margin-bottom: 30px;
        text-shadow: 0 0 10px #0ff;
      }

      .menu-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        max-width: 800px;
      }

      .upgrade-option,
      .shop-item,
      .ship-option {
        width: 250px;
        padding: 15px;
        margin: 10px;
        background: rgba(0, 100, 150, 0.5);
        border: 2px solid #0ff;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s;
        pointer-events: auto;
      }

      .upgrade-option:hover,
      .shop-item:hover,
      .ship-option:hover {
        transform: scale(1.05);
        background: rgba(0, 150, 200, 0.7);
        box-shadow: 0 0 15px #0ff;
      }

      .upgrade-option h3,
      .shop-item h3,
      .ship-option h3 {
        margin: 0 0 6px;
        color: #ff0;
      }

      .shop-item .price {
        color: #0f0;
        font-weight: bold;
      }

      .ship-stats {
        font-size: 14px;
        margin-top: 10px;
      }

      .ship-stats span {
        color: #0ff;
      }

      /* Start / Game Over screens */
      #startScreen,
      #gameOverScreen {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 200;
        color: #fff;
      }

      #gameOverScreen {
        display: none;
      }

      #highScores {
        margin: 20px 0;
        font-size: 18px;
      }

      .screen-title {
        font-size: 48px;
        margin-bottom: 20px;
        text-shadow: 0 0 10px #0ff;
      }

      .screen-button {
        padding: 15px 30px;
        font-size: 20px;
        background: linear-gradient(45deg, #0ff, #08f);
        border: none;
        border-radius: 30px;
        color: #fff;
        cursor: pointer;
        transition: all 0.3s;
        pointer-events: auto;
      }

      .screen-button:hover {
        transform: scale(1.1);
        box-shadow: 0 0 15px #0ff;
      }

      /* Boss health bar */
      #bossHealth {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 300px;
        height: 20px;
        background: rgba(255, 0, 0, 0.3);
        border-radius: 10px;
        overflow: hidden;
        display: none;
        z-index: 150;
      }

      #bossHealthFill {
        height: 100%;
        width: 100%;
        background: linear-gradient(90deg, #ff0000, #ff8800);
      }

      /* Zone indicator */
      #zoneIndicator {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        text-align: center;
        font-size: 48px;
        color: #fff;
        text-shadow: 0 0 10px #0ff;
        transform: translateY(-50%);
        opacity: 0;
        transition: opacity 1s;
        pointer-events: none;
        z-index: 150;
      }
    </style>
  </head>

  <body>
    <canvas id="gameCanvas"></canvas>

    <div id="ui">
      <div id="score">SCORE: 0</div>
      <div id="highScore">HIGH SCORE: 0</div>
      <div id="money">CREDITS: 0</div>
      <div id="level">LEVEL: 1</div>
      <div id="xp">XP: 0/100</div>
      <div id="zone">ZONE: 1</div>
      <div id="healthBar">
        <div id="healthFill"></div>
      </div>
    </div>

    <div id="bossHealth">
      <div id="bossHealthFill"></div>
    </div>

    <div id="zoneIndicator"></div>

    <!-- Upgrade screen -->
    <div id="upgradeScreen">
      <h2 class="menu-title">CHOOSE AN UPGRADE</h2>
      <div class="menu-container">
        <div class="upgrade-option" onclick="selectUpgrade(0)">
          <h3>FIRE RATE</h3>
          <p>Increases how fast you shoot by 25%</p>
        </div>
        <div class="upgrade-option" onclick="selectUpgrade(1)">
          <h3>MULTI-SHOT</h3>
          <p>Adds 2 additional bullets at angles</p>
        </div>
        <div class="upgrade-option" onclick="selectUpgrade(2)">
          <h3>SPEED BOOST</h3>
          <p>Increases movement speed by 20%</p>
        </div>
        <div class="upgrade-option" onclick="selectUpgrade(3)">
          <h3>HEALTH BOOST</h3>
          <p>Increase max health by 25%</p>
        </div>
      </div>
    </div>

    <!-- Shop screen -->
    <div id="shopScreen">
      <h2 class="menu-title">
        SHOP - CREDITS: <span id="shopMoney">0</span>
      </h2>
      <div class="menu-container">
        <div class="shop-item" onclick="buyUpgrade(0)">
          <h3>MINI-SHIP</h3>
          <p>Adds an autonomous fighter</p>
          <div class="price">COST: 500</div>
        </div>
        <div class="shop-item" onclick="buyUpgrade(1)">
          <h3>SHIELD CHARGE</h3>
          <p>Restores 50% of max health</p>
          <div class="price">COST: 300</div>
        </div>
        <div class="shop-item" onclick="buyUpgrade(2)">
          <h3>POWER SHOT</h3>
          <p>Next 10 shots deal double damage</p>
          <div class="price">COST: 400</div>
        </div>
        <div class="shop-item" onclick="buyUpgrade(3)">
          <h3>ZONE SKIP</h3>
          <p>Skip to next boss zone</p>
          <div class="price">COST: 1000</div>
        </div>
      </div>
      <button class="screen-button" onclick="exitShop()">CONTINUE</button>
    </div>

    <!-- Ship selection -->
    <div id="shipSelectScreen">
      <h2 class="menu-title">SELECT YOUR SHIP</h2>
      <div class="menu-container">
        <div class="ship-option" onclick="selectShip(0)">
          <h3>STRIKER</h3>
          <div class="ship-stats">
            <div>Fire Rate: <span>Fast</span></div>
            <div>Health: <span>Medium</span></div>
            <div>Special: <span>+1 Multi-Shot</span></div>
          </div>
        </div>
        <div class="ship-option" onclick="selectShip(1)">
          <h3>TANK</h3>
          <div class="ship-stats">
            <div>Fire Rate: <span>Slow</span></div>
            <div>Health: <span>High</span></div>
            <div>Special: <span>+50% Health</span></div>
          </div>
        </div>
        <div class="ship-option" onclick="selectShip(2)">
          <h3>SNIPER</h3>
          <div class="ship-stats">
            <div>Fire Rate: <span>Medium</span></div>
            <div>Health: <span>Low</span></div>
            <div>Special: <span>Piercing Shots</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Start screen -->
    <div id="startScreen">
      <h1 class="screen-title">GALACTIC SHOOTER</h1>
      <p>Defeat enemies, upgrade your ship, and conquer the galaxy!</p>
      <button class="screen-button" id="startButton">START GAME</button>
    </div>

    <!-- Game Over -->
    <div id="gameOverScreen">
      <h1 class="screen-title">GAME OVER</h1>
      <div id="finalScore">SCORE: 0</div>
      <div id="highScores"></div>
      <button class="screen-button" id="restartButton">PLAY AGAIN</button>
    </div>

    <script>
      // Core game state
      const game = {
        canvas: null,
        ctx: null,

        player: {
          x: 0,
          y: 0,
          width: 40,
          height: 60,
          speed: 5,
          health: 100,
          maxHealth: 100,
          fireRate: 300,
          lastShot: 0,
          bulletSpeed: 10,
          multiShotPairs: 0, // Number of angled pairs (each pair = 2 bullets)
          miniShips: 0,
          powerShots: 0, // "Shots", not bullets
          shipType: 0,
          color: "#00ffff",

          shipTypes: [
            {
              // Striker
              name: "Striker",
              fireRate: 250,
              maxHealth: 100,
              speed: 5,
              multiShotPairs: 1,
              bulletPiercing: false,
              color: "#00ffff",
            },
            {
              // Tank
              name: "Tank",
              fireRate: 400,
              maxHealth: 150,
              speed: 4,
              multiShotPairs: 0,
              bulletPiercing: false,
              color: "#ff8800",
            },
            {
              // Sniper
              name: "Sniper",
              fireRate: 350,
              maxHealth: 80,
              speed: 6,
              multiShotPairs: 0,
              bulletPiercing: true,
              color: "#ff00ff",
            },
          ],
        },

        bullets: [],
        enemies: [],
        explosions: [],
        stars: [],
        miniShips: [],

        score: 0,
        highScore:
          Number(localStorage.getItem("galacticShooterHighScore")) || 0,
        money: 0,
        level: 1,
        xp: 0,
        xpToNextLevel: 100,
        zone: 1,
        zoneEnemiesDefeated: 0,
        zoneEnemiesRequired: 10,
        bossActive: false,
        boss: null,

        gameRunning: false,
        keys: {
          ArrowUp: false,
          ArrowDown: false,
          ArrowLeft: false,
          ArrowRight: false,
          Space: false,
        },

        upgrades: [
          {
            name: "Fire Rate",
            description: "Shoot 25% faster",
            apply: () => (game.player.fireRate = Math.max(60, game.player.fireRate * 0.75)),
          },
          {
            name: "Multi-Shot",
            description: "Adds 2 angled bullets",
            apply: () => game.player.multiShotPairs++,
          },
          {
            name: "Speed Boost",
            description: "Move 20% faster",
            apply: () => (game.player.speed *= 1.2),
          },
          {
            name: "Health Boost",
            description: "Increase max health by 25%",
            apply: () => {
              game.player.maxHealth = Math.floor(game.player.maxHealth * 1.25);
              game.player.health = game.player.maxHealth;
              updateHealthBar();
            },
          },
        ],

        shopItems: [
          {
            name: "Mini-Ship",
            description: "Adds an autonomous fighter",
            cost: 500,
            apply: () => {
              game.player.miniShips++;
              spawnMiniShip();
            },
          },
          {
            name: "Shield Charge",
            description: "Restores 50% of max health",
            cost: 300,
            apply: () => {
              game.player.health = Math.min(
                game.player.maxHealth,
                game.player.health + game.player.maxHealth * 0.5
              );
              updateHealthBar();
            },
          },
          {
            name: "Power Shot",
            description: "Next 10 shots deal double damage",
            cost: 400,
            apply: () => {
              game.player.powerShots += 10;
            },
          },
          {
            name: "Zone Skip",
            description: "Skip to next boss zone",
            cost: 1000,
            apply: () => {
              const nextBossZone = Math.ceil((game.zone + 1) / 3) * 3; // 3,6,9...
              game.zone = nextBossZone;
              game.zoneEnemiesDefeated = 0;
              game.zoneEnemiesRequired = 0;
              spawnBoss();
              updateUI();
            },
          },
        ],

        enemyTypes: [
          {
            // Basic enemy (triangle)
            name: "Fighter",
            shape: "triangle",
            color: "#ff5555",
            speed: 1.5,
            health: 2,
            behavior: "straight",
            score: 100,
          },
          {
            // Shooter enemy (square)
            name: "Gunner",
            shape: "square",
            color: "#55ff55",
            speed: 1,
            health: 3,
            behavior: "shooter",
            shotDelay: 1500,
            score: 150,
          },
          {
            // Zigzag enemy (pentagon)
            name: "Dodger",
            shape: "pentagon",
            color: "#5555ff",
            speed: 2,
            health: 1,
            behavior: "zigzag",
            amplitude: 100,
            score: 200,
          },
          {
            // Bomber enemy (circle)
            name: "Bomber",
            shape: "circle",
            color: "#ff00ff",
            speed: 0.8,
            health: 5,
            behavior: "bomber",
            bombDelay: 2000,
            score: 300,
          },
        ],

        bossTypes: [
          {
            // Basic boss
            name: "Warbringer",
            health: 20,
            speed: 1,
            shotDelay: 1000,
            pattern: "circle",
          },
          {
            // Fast boss
            name: "Swiftblade",
            health: 15,
            speed: 2,
            shotDelay: 800,
            pattern: "spiral",
          },
          {
            // Tank boss
            name: "Ironclad",
            health: 30,
            speed: 0.7,
            shotDelay: 1200,
            pattern: "spread",
          },
        ],

        currentUpgrades: [],
        menuActive: false,
      };

      // DOM elements
      const uiElements = {
        score: document.getElementById("score"),
        highScore: document.getElementById("highScore"),
        money: document.getElementById("money"),
        level: document.getElementById("level"),
        xp: document.getElementById("xp"),
        zone: document.getElementById("zone"),
        healthFill: document.getElementById("healthFill"),

        upgradeScreen: document.getElementById("upgradeScreen"),
        shopScreen: document.getElementById("shopScreen"),
        shopMoney: document.getElementById("shopMoney"),
        shipSelectScreen: document.getElementById("shipSelectScreen"),

        startScreen: document.getElementById("startScreen"),
        gameOverScreen: document.getElementById("gameOverScreen"),
        finalScore: document.getElementById("finalScore"),
        highScores: document.getElementById("highScores"),
        startButton: document.getElementById("startButton"),
        restartButton: document.getElementById("restartButton"),

        bossHealth: document.getElementById("bossHealth"),
        bossHealthFill: document.getElementById("bossHealthFill"),

        zoneIndicator: document.getElementById("zoneIndicator"),
      };

      // Initialize
      function init() {
        game.canvas = document.getElementById("gameCanvas");
        game.ctx = game.canvas.getContext("2d");

        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);

        // Input
        document.addEventListener("keydown", handleKeyDown, { passive: true });
        document.addEventListener("keyup", handleKeyUp, { passive: true });
        document.addEventListener("mousemove", handleMouseMove, {
          passive: true,
        });

        uiElements.startButton.addEventListener("click", showShipSelect);
        uiElements.restartButton.addEventListener("click", restartGame);

        // Starfield
        for (let i = 0; i < 200; i++) {
          game.stars.push({
            x: Math.random() * game.canvas.width,
            y: Math.random() * game.canvas.height,
            size: Math.random() * 2 + 1,
            speed: Math.random() * 2 + 1,
          });
        }

        updateHighScoreDisplay();

        requestAnimationFrame(gameLoop);
      }

      // Canvas sizing
      function resizeCanvas() {
        game.canvas.width = window.innerWidth;
        game.canvas.height = window.innerHeight;

        if (game.player) {
          game.player.x = game.canvas.width / 2 - game.player.width / 2;
          game.player.y = game.canvas.height - game.player.height - 20;
        }
      }

      // Input handling
      function handleKeyDown(e) {
        // Pause toggle always available (except during hard overlays)
        if (e.key === "p" || e.key === "P" || e.key === "Escape") {
          togglePause();
          return;
        }

        if (game.menuActive) return;

        // Movement keys: Arrows + WASD
        if (e.key === "ArrowUp" || e.key === "w" || e.key === "W")
          game.keys.ArrowUp = true;
        if (e.key === "ArrowDown" || e.key === "s" || e.key === "S")
          game.keys.ArrowDown = true;
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A")
          game.keys.ArrowLeft = true;
        if (e.key === "ArrowRight" || e.key === "d" || e.key === "D")
          game.keys.ArrowRight = true;

        // Spacebar - support multiple identifiers
        if (e.code === "Space" || e.key === " " || e.key === "Space") {
          game.keys.Space = true;
        }
      }

      function handleKeyUp(e) {
        if (e.key === "ArrowUp" || e.key === "w" || e.key === "W")
          game.keys.ArrowUp = false;
        if (e.key === "ArrowDown" || e.key === "s" || e.key === "S")
          game.keys.ArrowDown = false;
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A")
          game.keys.ArrowLeft = false;
        if (e.key === "ArrowRight" || e.key === "d" || e.key === "D")
          game.keys.ArrowRight = false;

        if (e.code === "Space" || e.key === " " || e.key === "Space") {
          game.keys.Space = false;
        }
      }

      function handleMouseMove(e) {
        if (!game.gameRunning || game.menuActive) return;
        game.player.x = e.clientX - game.player.width / 2;
      }

      function isOverlayOpen() {
        return (
          uiElements.upgradeScreen.style.display === "flex" ||
          uiElements.shopScreen.style.display === "flex"
        );
      }

      function togglePause() {
        if (!game.gameRunning) return;
        if (isOverlayOpen()) return;
        game.menuActive = !game.menuActive;
        showZoneIndicator(game.menuActive ? "PAUSED" : `ZONE ${game.zone}`);
      }

      // Game management
      function showShipSelect() {
        uiElements.startScreen.style.display = "none";
        uiElements.shipSelectScreen.style.display = "flex";
      }

      function selectShip(type) {
        game.player.shipType = type;
        const st = game.player.shipTypes[type];

        game.player.fireRate = st.fireRate;
        game.player.maxHealth = st.maxHealth;
        game.player.health = st.maxHealth;
        game.player.speed = st.speed;
        game.player.multiShotPairs = st.multiShotPairs;
        game.player.color = st.color;

        startGame();
      }

      function startGame() {
        uiElements.shipSelectScreen.style.display = "none";
        uiElements.gameOverScreen.style.display = "none";
        uiElements.upgradeScreen.style.display = "none";
        uiElements.shopScreen.style.display = "none";

        // Reset game state
        game.bullets = [];
        game.enemies = [];
        game.explosions = [];
        game.miniShips = [];

        game.score = 0;
        game.money = 0;

        game.level = 1;
        game.xp = 0;
        game.xpToNextLevel = 100;

        game.zone = 1;
        game.zoneEnemiesDefeated = 0;
        game.zoneEnemiesRequired = 10;

        game.bossActive = false;
        game.boss = null;

        game.gameRunning = true;
        game.menuActive = false;

        // Player position
        game.player.x = game.canvas.width / 2 - game.player.width / 2;
        game.player.y = game.canvas.height - game.player.height - 20;

        updateUI();
        showZoneIndicator(`ZONE ${game.zone}`);
      }

      function restartGame() {
        startGame();
      }

      function gameOver() {
        game.gameRunning = false;

        // Save high score
        if (game.score > game.highScore) {
          game.highScore = game.score;
          localStorage.setItem(
            "galacticShooterHighScore",
            String(game.highScore)
          );
        }

        uiElements.finalScore.textContent = `SCORE: ${game.score}`;
        updateHighScoreDisplay();
        uiElements.gameOverScreen.style.display = "flex";

        // Big explosion
        createExplosion(
          game.player.x + game.player.width / 2,
          game.player.y + game.player.height / 2,
          50,
          "#ff0000"
        );
      }

      // UI
      function updateUI() {
        uiElements.score.textContent = `SCORE: ${game.score}`;
        uiElements.highScore.textContent = `HIGH SCORE: ${game.highScore}`;
        uiElements.money.textContent = `CREDITS: ${game.money}`;
        uiElements.level.textContent = `LEVEL: ${game.level}`;
        uiElements.xp.textContent = `XP: ${game.xp}/${game.xpToNextLevel}`;
        uiElements.zone.textContent = `ZONE: ${game.zone}`;
        updateHealthBar();
      }

      function updateHealthBar() {
        const percent = Math.max(
          0,
          Math.min(100, (game.player.health / game.player.maxHealth) * 100)
        );
        uiElements.healthFill.style.width = `${percent}%`;

        if (percent > 60) {
          uiElements.healthFill.style.background =
            "linear-gradient(90deg, #00ff00, #00ff88)";
        } else if (percent > 30) {
          uiElements.healthFill.style.background =
            "linear-gradient(90deg, #ffff00, #ff8800)";
        } else {
          uiElements.healthFill.style.background =
            "linear-gradient(90deg, #ff0000, #ff0088)";
        }
      }

      function updateHighScoreDisplay() {
        uiElements.highScores.innerHTML = `<div>HIGH SCORE: ${game.highScore}</div>`;
      }

      function showZoneIndicator(text) {
        uiElements.zoneIndicator.textContent = text;
        uiElements.zoneIndicator.style.opacity = "1";
        setTimeout(() => {
          uiElements.zoneIndicator.style.opacity = "0";
        }, 2000);
      }

      // Helpers
      function createBullet(
        centerX,
        centerY,
        width,
        height,
        speed,
        dirRadians,
        options = {}
      ) {
        const angle = dirRadians;
        const vx = Math.cos(angle) * speed;
        const vy = Math.sin(angle) * speed;

        return {
          x: centerX - width / 2,
          y: centerY - height / 2,
          width,
          height,
          speed,
          angle,
          vx,
          vy,
          isEnemy: !!options.isEnemy,
          isBomb: !!options.isBomb,
          isPower: !!options.isPower,
          pierces: options.pierces || 0,
        };
      }

      function createExplosion(x, y, radius, color) {
        const explosion = {
          x,
          y,
          radius,
          color,
          particles: [],
          life: 30,
        };
        for (let i = 0; i < 30; i++) {
          explosion.particles.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            size: Math.random() * 3 + 1,
          });
        }
        game.explosions.push(explosion);
      }

      // Mechanics
      function shoot() {
        const now = Date.now();
        if (now - game.player.lastShot < game.player.fireRate) return;

        const centerX = game.player.x + game.player.width / 2;
        const centerY = game.player.y;
        const baseDir = -Math.PI / 2; // straight up

        const ship = game.player.shipTypes[game.player.shipType];
        const pierces = ship.bulletPiercing ? 1 : 0;

        const usePowerThisShot = game.player.powerShots > 0;
        if (usePowerThisShot) game.player.powerShots--;

        // Main bullet
        game.bullets.push(
          createBullet(
            centerX,
            centerY,
            6,
            15,
            game.player.bulletSpeed,
            baseDir,
            {
              isPower: usePowerThisShot,
              pierces,
            }
          )
        );

        // Multi-shot pairs
        const pairs = game.player.multiShotPairs;
        if (pairs > 0) {
          const angleStep = 0.2;
          for (let i = 1; i <= pairs; i++) {
            const offset = angleStep * i;

            game.bullets.push(
              createBullet(
                centerX,
                centerY,
                6,
                15,
                game.player.bulletSpeed,
                baseDir + offset,
                { isPower: usePowerThisShot, pierces }
              )
            );

            game.bullets.push(
              createBullet(
                centerX,
                centerY,
                6,
                15,
                game.player.bulletSpeed,
                baseDir - offset,
                { isPower: usePowerThisShot, pierces }
              )
            );
          }
        }

        game.player.lastShot = now;
      }

      function spawnMiniShip() {
        game.miniShips.push({
          x: Math.random() > 0.5 ? 0 : game.canvas.width - 30,
          y: game.canvas.height - 100,
          width: 20,
          height: 30,
          speed: 3,
          direction: Math.random() > 0.5 ? 1 : -1,
          lastShot: 0,
          fireRate: 1000,
        });
      }

      function spawnEnemy() {
        // Scale difficulty with zone and level
        const difficulty = game.zone * 0.5 + game.level * 0.3;
        const typeIndex = Math.min(
          Math.floor(
            Math.random() * (game.enemyTypes.length + difficulty * 0.3)
          ),
          game.enemyTypes.length - 1
        );
        const enemyType = game.enemyTypes[typeIndex];

        const size = 30 + Math.random() * 20;
        const health = Math.floor(enemyType.health * (1 + difficulty * 0.2));
        const speed = enemyType.speed * (1 + difficulty * 0.1);

        const enemy = {
          x: Math.random() * (game.canvas.width - size),
          y: -size,
          width: size,
          height: size,
          speed,
          health,
          type: enemyType,
          behavior: enemyType.behavior,
          moveTimer: 0,
          lastShot: 0,
          startX: 0,
          amplitude: enemyType.amplitude || 0,
        };

        if (enemy.behavior === "zigzag") {
          enemy.startX = enemy.x;
        }

        game.enemies.push(enemy);
      }

      function spawnBoss() {
        game.bossActive = true;
        uiElements.bossHealth.style.display = "block";

        const bossType =
          game.bossTypes[Math.floor(Math.random() * game.bossTypes.length)];
        const health = Math.floor(bossType.health * (1 + game.zone * 0.3));

        game.boss = {
          x: game.canvas.width / 2 - 75,
          y: -150,
          width: 150,
          height: 150,
          speed: bossType.speed,
          health,
          maxHealth: health,
          type: bossType,
          pattern: bossType.pattern,
          lastShot: 0,
          shotDelay: bossType.shotDelay,
          moveTimer: 0,
          movePattern: 0,
        };

        updateBossHealth();
        showZoneIndicator(`BOSS: ${bossType.name}`);
      }

      function addXP(amount) {
        game.xp += amount;
        if (game.xp >= game.xpToNextLevel) {
          levelUp();
        }
        updateUI();
      }

      function addMoney(amount) {
        const scaledAmount = Math.floor(amount * (0.5 + game.zone * 0.5));
        game.money += scaledAmount;
        updateUI();
      }

      function levelUp() {
        game.level++;
        game.xp -= game.xpToNextLevel;
        game.xpToNextLevel = Math.floor(game.xpToNextLevel * 1.2);

        // Show upgrade screen with random options
        game.currentUpgrades = [];
        const availableUpgrades = [...game.upgrades];

        for (let i = 0; i < 4 && availableUpgrades.length > 0; i++) {
          const randomIndex = Math.floor(
            Math.random() * availableUpgrades.length
          );
          game.currentUpgrades.push(availableUpgrades[randomIndex]);
          availableUpgrades.splice(randomIndex, 1);
        }

        // Update upgrade screen options
        const options =
          uiElements.upgradeScreen.querySelectorAll(".upgrade-option");
        options.forEach((option, index) => {
          if (index < game.currentUpgrades.length) {
            option.querySelector("h3").textContent =
              game.currentUpgrades[index].name;
            option.querySelector("p").textContent =
              game.currentUpgrades[index].description;
            option.style.display = "block";
          } else {
            option.style.display = "none";
          }
        });

        game.gameRunning = false;
        game.menuActive = true;
        uiElements.upgradeScreen.style.display = "flex";
      }

      function selectUpgrade(index) {
        if (index < game.currentUpgrades.length) {
          game.currentUpgrades[index].apply();
        }

        uiElements.upgradeScreen.style.display = "none";
        game.gameRunning = true;
        game.menuActive = false;
        updateUI();
      }

      function openShop() {
        uiElements.shopMoney.textContent = game.money;
        uiElements.shopScreen.style.display = "flex";
        game.gameRunning = false;
        game.menuActive = true;
      }

      function buyUpgrade(index) {
        const item = game.shopItems[index];
        if (game.money >= item.cost) {
          game.money -= item.cost;
          item.apply();
          updateUI();
          uiElements.shopMoney.textContent = game.money;
        }
      }

      function exitShop() {
        uiElements.shopScreen.style.display = "none";
        game.gameRunning = true;
        game.menuActive = false;
        nextZone();
      }

      function nextZone() {
        game.zone++;
        game.zoneEnemiesDefeated = 0;
        game.zoneEnemiesRequired = 10 + game.zone * 2;

        if (game.zone % 3 === 0) {
          spawnBoss();
        } else {
          showZoneIndicator(`ZONE ${game.zone}`);
        }

        updateUI();
      }

      // Collision detection
      function checkCollision(a, b) {
        return (
          a.x < b.x + b.width &&
          a.x + a.width > b.x &&
          a.y < b.y + b.height &&
          a.y + a.height > b.y
        );
      }

      function clamp(val, min, max) {
        return Math.max(min, Math.min(max, val));
      }

      // Main game loop
      function gameLoop() {
        const ctx = game.ctx;
        ctx.clearRect(0, 0, game.canvas.width, game.canvas.height);

        // Starfield
        ctx.fillStyle = "white";
        for (const star of game.stars) {
          ctx.fillRect(star.x, star.y, star.size, star.size);
          star.y += star.speed;
          if (star.y > game.canvas.height) {
            star.y = 0;
            star.x = Math.random() * game.canvas.width;
          }
        }

        if (game.gameRunning && !game.menuActive) {
          // Player movement
          if (game.keys.ArrowLeft) game.player.x -= game.player.speed;
          if (game.keys.ArrowRight) game.player.x += game.player.speed;
          if (game.keys.ArrowUp) game.player.y -= game.player.speed;
          if (game.keys.ArrowDown) game.player.y += game.player.speed;

          // Bounds
          game.player.x = clamp(
            game.player.x,
            0,
            game.canvas.width - game.player.width
          );
          game.player.y = clamp(
            game.player.y,
            0,
            game.canvas.height - game.player.height
          );

          if (game.keys.Space) shoot();

          // Spawn enemies (not in boss fight)
          if (
            !game.bossActive &&
            game.enemies.length < 5 + game.zone &&
            Math.random() < 0.02 * (1 + game.zone * 0.1)
          ) {
            spawnEnemy();
          }

          // Update bullets (movement and collisions)
          for (let i = game.bullets.length - 1; i >= 0; i--) {
            const bullet = game.bullets[i];

            bullet.x += bullet.vx;
            bullet.y += bullet.vy;

            // Remove if off screen
            if (
              bullet.y < -40 ||
              bullet.y > game.canvas.height + 40 ||
              bullet.x < -40 ||
              bullet.x > game.canvas.width + 40
            ) {
              game.bullets.splice(i, 1);
              continue;
            }

            // Player bullets -> enemies
            if (!bullet.isEnemy && !bullet.isBomb) {
              // Enemies
              let hitSomething = false;
              for (let j = game.enemies.length - 1; j >= 0; j--) {
                const enemy = game.enemies[j];
                if (checkCollision(bullet, enemy)) {
                  enemy.health -= bullet.isPower ? 2 : 1;
                  hitSomething = true;

                  if (enemy.health <= 0) {
                    createExplosion(
                      enemy.x + enemy.width / 2,
                      enemy.y + enemy.height / 2,
                      enemy.width / 2,
                      enemy.type.color
                    );

                    game.score += enemy.type.score * game.zone;
                    game.zoneEnemiesDefeated++;
                    addXP(20 + enemy.type.health * 5);
                    addMoney(enemy.type.score / 2);

                    if (
                      !game.bossActive &&
                      game.zoneEnemiesDefeated >= game.zoneEnemiesRequired
                    ) {
                      nextZone();
                    }

                    game.enemies.splice(j, 1);
                  }

                  if (bullet.pierces > 0) {
                    bullet.pierces--;
                  } else {
                    game.bullets.splice(i, 1);
                  }
                  break;
                }
              }

              // Boss
              if (
                !hitSomething &&
                game.bossActive &&
                game.boss &&
                checkCollision(bullet, game.boss)
              ) {
                game.boss.health -= bullet.isPower ? 2 : 1;
                updateBossHealth();

                if (bullet.pierces > 0) {
                  bullet.pierces--;
                } else {
                  game.bullets.splice(i, 1);
                }

                if (game.boss.health <= 0) {
                  createExplosion(
                    game.boss.x + game.boss.width / 2,
                    game.boss.y + game.boss.height / 2,
                    game.boss.width / 2,
                    "#ff00ff"
                  );

                  game.score += 5000 * game.zone;
                  addXP(100 * game.zone);
                  addMoney(1000 * game.zone);
                  game.bossActive = false;
                  uiElements.bossHealth.style.display = "none";
                  game.boss = null;

                  // Open shop after boss
                  setTimeout(openShop, 1000);
                }
              }
            }

            // Enemy bullets/bombs -> player
            if (bullet.isEnemy || bullet.isBomb) {
              if (checkCollision(bullet, game.player)) {
                game.player.health -= bullet.isBomb ? 15 : 10;
                if (game.player.health <= 0) gameOver();
                updateHealthBar();
                game.bullets.splice(i, 1);

                if (bullet.isBomb) {
                  createExplosion(
                    bullet.x + bullet.width / 2,
                    bullet.y + bullet.height / 2,
                    30,
                    "#ff0000"
                  );
                }
              }
            }
          }

          // Update enemies
          const now = Date.now();
          for (let i = game.enemies.length - 1; i >= 0; i--) {
            const enemy = game.enemies[i];

            if (enemy.behavior === "straight") {
              enemy.y += enemy.speed;
            } else if (enemy.behavior === "zigzag") {
              enemy.moveTimer++;
              enemy.y += enemy.speed;
              enemy.x =
                enemy.startX +
                Math.sin(enemy.moveTimer * 0.05) * enemy.amplitude;
            } else if (enemy.behavior === "shooter") {
              enemy.y += enemy.speed * 0.5;

              if (now - enemy.lastShot > enemy.type.shotDelay) {
                // Aim at player
                const ex = enemy.x + enemy.width / 2;
                const ey = enemy.y + enemy.height / 2;
                const px = game.player.x + game.player.width / 2;
                const py = game.player.y + game.player.height / 2;
                const angle = Math.atan2(py - ey, px - ex);

                game.bullets.push(
                  createBullet(ex, ey, 6, 15, 5, angle, { isEnemy: true })
                );

                enemy.lastShot = now;
              }
            } else if (enemy.behavior === "bomber") {
              enemy.y += enemy.speed * 0.3;

              if (now - enemy.lastShot > enemy.type.bombDelay) {
                // Bomb goes straight down
                const ex = enemy.x + enemy.width / 2;
                const ey = enemy.y + enemy.height;
                game.bullets.push(
                  createBullet(ex, ey, 10, 10, 3, Math.PI / 2, {
                    isBomb: true,
                    isEnemy: true,
                  })
                );
                enemy.lastShot = now;
              }
            }

            // Off screen bottom => damage player
            if (enemy.y > game.canvas.height) {
              game.enemies.splice(i, 1);
              game.player.health -= 5;
              if (game.player.health <= 0) gameOver();
              updateHealthBar();
              continue;
            }

            // Collision with player
            if (checkCollision(enemy, game.player)) {
              createExplosion(
                enemy.x + enemy.width / 2,
                enemy.y + enemy.height / 2,
                enemy.width / 2,
                enemy.type.color
              );

              game.player.health -= 10 + enemy.type.health * 2;
              game.enemies.splice(i, 1);

              if (game.player.health <= 0) gameOver();
              updateHealthBar();
            }
          }

          // Update mini-ships
          for (let i = 0; i < game.miniShips.length; i++) {
            const ship = game.miniShips[i];

            ship.x += ship.speed * ship.direction;
            if (ship.x <= 0) ship.direction = 1;
            else if (ship.x >= game.canvas.width - ship.width) ship.direction = -1;

            const now2 = Date.now();
            if (now2 - ship.lastShot > ship.fireRate) {
              const cx = ship.x + ship.width / 2;
              const cy = ship.y;
              game.bullets.push(
                createBullet(cx, cy, 6, 15, 8, -Math.PI / 2, {})
              );
              ship.lastShot = now2;
            }
          }

          // Update boss
          if (game.bossActive && game.boss) {
            const b = game.boss;
            b.moveTimer++;

            if (b.movePattern === 0) {
              // Enter from top
              b.y += b.speed;
              if (b.y > 50) {
                b.movePattern = 1;
                b.moveTimer = 0;
              }
            } else if (b.movePattern === 1) {
              // Left to right
              b.x += b.speed;
              if (b.x > game.canvas.width - b.width) {
                b.movePattern = 2;
              }
            } else if (b.movePattern === 2) {
              // Right to left
              b.x -= b.speed;
              if (b.x < 0) {
                b.movePattern = 1;
              }
            }

            const now3 = Date.now();
            if (now3 - b.lastShot > b.shotDelay) {
              const cx = b.x + b.width / 2;
              const cy = b.y + b.height / 2;

              if (b.type.pattern === "circle") {
                for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 6) {
                  game.bullets.push(
                    createBullet(cx, cy, 6, 15, 5, angle, { isEnemy: true })
                  );
                }
              } else if (b.type.pattern === "spiral") {
                const spiralAngle = b.moveTimer * 0.1;
                for (let i = 0; i < 3; i++) {
                  const angle = spiralAngle + (i * Math.PI * 2) / 3;
                  game.bullets.push(
                    createBullet(cx, cy, 6, 15, 5, angle, { isEnemy: true })
                  );
                }
              } else if (b.type.pattern === "spread") {
                // Aim at player then spread
                const px = game.player.x + game.player.width / 2;
                const py = game.player.y + game.player.height / 2;
                const base = Math.atan2(py - cy, px - cx);
                for (
                  let off = -Math.PI / 6;
                  off <= Math.PI / 6 + 0.0001;
                  off += Math.PI / 12
                ) {
                  game.bullets.push(
                    createBullet(cx, cy, 6, 15, 5, base + off, { isEnemy: true })
                  );
                }
              }

              b.lastShot = now3;
              b.shotDelay = Math.max(400, b.type.shotDelay - game.zone * 20);
            }

            // Boss-player collision
            if (checkCollision(b, game.player)) {
              game.player.health -= 20;
              if (game.player.health <= 0) gameOver();
              updateHealthBar();
            }
          }
        }

        // Draw explosions
        for (let i = game.explosions.length - 1; i >= 0; i--) {
          const explosion = game.explosions[i];
          explosion.life--;
          if (explosion.life <= 0) {
            game.explosions.splice(i, 1);
            continue;
          }

          ctx.fillStyle = explosion.color;
          ctx.globalAlpha = explosion.life / 30;
          for (const p of explosion.particles) {
            p.x += p.vx;
            p.y += p.vy;
            ctx.fillRect(p.x, p.y, p.size, p.size);
          }
          ctx.globalAlpha = 1;
        }

        // Draw bullets
        for (const bullet of game.bullets) {
          if (bullet.isEnemy) {
            ctx.fillStyle = "#ff0000";
          } else if (bullet.isBomb) {
            ctx.fillStyle = "#ff8800";
          } else if (bullet.isPower) {
            ctx.fillStyle = "#ffff00";
          } else {
            ctx.fillStyle = game.player.color;
          }

          ctx.save();
          ctx.translate(bullet.x + bullet.width / 2, bullet.y + bullet.height / 2);
          ctx.rotate(bullet.angle);
          ctx.fillRect(-bullet.width / 2, -bullet.height / 2, bullet.width, bullet.height);
          ctx.restore();
        }

        // Draw enemies
        for (const enemy of game.enemies) {
          ctx.fillStyle = enemy.type.color;
          ctx.globalAlpha = 0.7;

          if (enemy.type.shape === "triangle") {
            ctx.beginPath();
            ctx.moveTo(enemy.x + enemy.width / 2, enemy.y);
            ctx.lineTo(enemy.x, enemy.y + enemy.height);
            ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height);
            ctx.closePath();
            ctx.fill();
          } else if (enemy.type.shape === "square") {
            ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
          } else if (enemy.type.shape === "pentagon") {
            ctx.beginPath();
            ctx.moveTo(enemy.x + enemy.width / 2, enemy.y);
            ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height / 3);
            ctx.lineTo(enemy.x + enemy.width * 0.8, enemy.y + enemy.height);
            ctx.lineTo(enemy.x + enemy.width * 0.2, enemy.y + enemy.height);
            ctx.lineTo(enemy.x, enemy.y + enemy.height / 3);
            ctx.closePath();
            ctx.fill();
          } else if (enemy.type.shape === "circle") {
            ctx.beginPath();
            ctx.arc(
              enemy.x + enemy.width / 2,
              enemy.y + enemy.height / 2,
              enemy.width / 2,
              0,
              Math.PI * 2
            );
            ctx.fill();
          }

          ctx.globalAlpha = 1;
        }

        // Draw mini-ships
        ctx.fillStyle = "#8888ff";
        for (const ship of game.miniShips) {
          ctx.beginPath();
          ctx.moveTo(ship.x + ship.width / 2, ship.y);
          ctx.lineTo(ship.x, ship.y + ship.height);
          ctx.lineTo(ship.x + ship.width, ship.y + ship.height);
          ctx.closePath();
          ctx.fill();
        }

        // Draw boss
        if (game.bossActive && game.boss) {
          const b = game.boss;
          ctx.fillStyle = "#ff00ff";
          ctx.globalAlpha = 0.8;

          // Octagon boss
          ctx.beginPath();
          const centerX = b.x + b.width / 2;
          const centerY = b.y + b.height / 2;
          const radius = b.width / 2;

          for (let i = 0; i < 8; i++) {
            const angle = (i / 8) * Math.PI * 2;
            const x = centerX + Math.cos(angle) * radius;
            const y = centerY + Math.sin(angle) * radius;

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
          }

          ctx.closePath();
          ctx.fill();
          ctx.globalAlpha = 1;
        }

        // Draw player
        ctx.fillStyle = game.player.color;
        ctx.beginPath();
        ctx.moveTo(game.player.x + game.player.width / 2, game.player.y);
        ctx.lineTo(game.player.x, game.player.y + game.player.height);
        ctx.lineTo(game.player.x + game.player.width, game.player.y + game.player.height);
        ctx.closePath();
        ctx.fill();

        // Engine glow
        if (game.gameRunning && !game.menuActive) {
          ctx.fillStyle = game.player.color;
          ctx.globalAlpha = 0.5;
          ctx.beginPath();
          ctx.moveTo(
            game.player.x + game.player.width / 2,
            game.player.y + game.player.height
          );
          ctx.lineTo(
            game.player.x + game.player.width / 3,
            game.player.y + game.player.height + 10
          );
          ctx.lineTo(
            game.player.x + (game.player.width * 2) / 3,
            game.player.y + game.player.height + 10
          );
          ctx.closePath();
          ctx.fill();
          ctx.globalAlpha = 1;
        }

        requestAnimationFrame(gameLoop);
      }

      function updateBossHealth() {
        if (!game.boss) return;
        const percent = Math.max(
          0,
          Math.min(100, (game.boss.health / game.boss.maxHealth) * 100)
        );
        uiElements.bossHealthFill.style.width = `${percent}%`;

        if (percent > 60) {
          uiElements.bossHealthFill.style.background =
            "linear-gradient(90deg, #ff0000, #ff8800)";
        } else if (percent > 30) {
          uiElements.bossHealthFill.style.background =
            "linear-gradient(90deg, #ff8800, #ffff00)";
        } else {
          uiElements.bossHealthFill.style.background =
            "linear-gradient(90deg, #ffff00, #ffffff)";
        }
      }

      // Start the game
      window.onload = init;
    </script>
  </body>
</html>
